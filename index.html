<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <title>Serpiente Sabia 2D</title>
    <style>
        body {
            color: white;
            font-family: 'Courier New', monospace, sans-serif; /* Fuente pixelada para estilo retro */
            text-align: center;
            background-color: #1a1a1a; /* Fondo oscuro */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Alinea los elementos al inicio (arriba) */
            min-height: 100vh; /* Ocupa el 100% de la altura de la ventana */
            min-height: 100dvh; /* Dynamic viewport height para móviles */
            margin: 0;
            overflow: hidden; /* Ocultamos el scroll */
            padding: 5px 0; /* Pequeño padding para que el contenido no toque los bordes */
            box-sizing: border-box; /* Incluir padding en la altura total */
            /* ¡Solución recomendada! */
            touch-action: none; /* Fuerza al navegador a no interpretar gestos como zoom o scroll en todo el body */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Standard */
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        h1 {
            color: #00ff00; /* Verde neón para el título */
            font-size: clamp(1.2em, 4vw, 1.6em); /* Responsive font size */
            margin-top: 5px; /* Margen superior muy reducido */
            margin-bottom: 5px;
        }
        canvas {
            background: #000;
            border: 2px solid #00ff00; /* Borde verde neón */
            display: block;
            margin: 5px auto; /* Margen vertical muy reducido */
            max-width: 95vw; /* Responsive width */
            max-height: 60vh; /* Responsive height */
            /* ¡Solución recomendada! */
            touch-action: none; /* Fuerza al navegador a no interpretar gestos como zoom o scroll en el canvas */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #game-header { /* Contenedor superior para instrucciones, puntaje y nivel */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 400px; /* Ancho del canvas */
            margin-bottom: 5px;
        }
        #instructions {
            font-size: 0.7em; /* Aún más pequeño para instrucciones */
            margin-bottom: 3px; /* Reducir aún más el margen inferior */
            color: #ccc;
        }
        #score-level-bar {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Alinea verticalmente los elementos */
            width: 100%;
            font-size: 0.9em; /* Más pequeño para puntaje/nivel */
            color: #fff;
            margin-top: 0px;
            padding: 0 5px;
            box-sizing: border-box;
        }
        #score, #level, #student-name-display { /* Ajustar para el nuevo display de nombre */
            margin: 0;
        }
        #student-name-display {
            color: #ffcc00; /* Color distintivo para el nombre */
        }

        /* --- Estilos para la Pantalla de Inicio --- */
        #start-screen {
            background-color: rgba(0, 0, 0, 0.95);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; /* Para que esté por encima de todo */
            color: #00ff00;
            font-size: 1.2em;
        }
        #start-screen h2 {
            color: #00ff00;
            margin-bottom: 20px;
        }
        #start-screen p {
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        #start-screen input, #start-screen select {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #00ff00;
            background-color: #333;
            color: white;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Courier New', monospace, sans-serif;
            max-width: 250px;
        }
        #start-screen button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: 'Courier New', monospace, sans-serif;
        }
        #start-screen button:hover {
            background-color: #00cc00;
        }

        /* --- Overlay de Instrucciones Iniciales --- */
        #initial-instructions-overlay {
            background-color: rgba(0, 0, 0, 0.95);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Inicialmente oculto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; /* AHORA EN Z-INDEX 30 O SUPERIOR PARA ASEGURAR VISIBILIDAD DE BOTÓN */
            color: #00ff00;
            font-size: 1.1em;
            padding: 20px;
            box-sizing: border-box;
            user-select: none; /* Prevenir selección de texto al tocar */
            -webkit-user-select: none;
            -ms-user-select: none;
            -moz-user-select: none;
        }
        #initial-instructions-overlay p {
            margin-bottom: 8px;
            line-height: 1.3;
        }
        #initial-instructions-overlay .instructions-title {
            font-size: 1.3em;
            color: #00ff00;
            margin-bottom: 15px;
        }
        #initial-instructions-overlay .instructions-cta {
            font-size: 1.2em;
            color: #ffcc00;
            margin-top: 20px;
        }
        /* Estilo para el nuevo botón dentro del overlay de instrucciones */
        #begin-game-button { /* Renombrado para consistencia, antes 'touch-to-start-button' */
            background-color: #00ff00;
            color: #000;
            font-size: 1em; /* Ajustado al pedido */
            border: none;
            padding: 10px 20px; /* Ajustado al pedido */
            font-family: 'Courier New', monospace, sans-serif;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 5px; /* Mantener bordes redondeados para estilo */
            transition: background-color 0.3s;
        }
        #begin-game-button:hover {
            background-color: #00cc00;
        }


        /* --- Estilos para la Pregunta en Overlay (solo durante el juego) --- */
        #question-overlay { /* Caja para la pregunta central y temporizador */
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 10px; /* Reducir padding */
            max-width: 70%;
            display: none; /* Inicialmente oculto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            min-height: 100px; /* Asegurar un tamaño mínimo */
            box-sizing: border-box;
            user-select: none; /* Prevenir selección de texto al tocar */
            -webkit-user-select: none; /* Para iOS */
            -ms-user-select: none; /* Para IE/Edge */
            -moz-user-select: none; /* Para Firefox */
            touch-action: manipulation; /* Evitar comportamientos del navegador como el zoom con doble toque */
        }
        #question-overlay.slide-out {
            transform: translate(-50%, 150%);
            opacity: 0;
        }
        #overlay-question-text {
            font-size: 1em; /* Ajustar tamaño de la pregunta central */
            margin-bottom: 8px; /* Reducir margen */
            color: #fff;
        }
        #overlay-timer-text {
            font-size: 0.8em; /* Más pequeño para el temporizador */
            color: #ffcc00;
        }
        #game-over-screen {
            background-color: rgba(0, 0, 0, 0.9);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            display: none;
        }
        #game-over-screen h2 {
            color: #ff0000;
            font-size: 2.2em; /* Reducir tamaño de "Juego Terminado" */
            margin-bottom: 10px;
        }
        #game-over-screen p {
            font-size: 1.1em; /* Reducir tamaño de texto en game over */
            margin-bottom: 15px;
        }
        #restart-button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 8px 15px; /* Reducir padding del botón */
            font-size: 0.9em; /* Reducir tamaño de fuente del botón */
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #restart-button:hover {
            background-color: #00cc00;
        }
        /* Estilo para la pregunta que aparece debajo del juego */
        #current-question-display {
            font-size: 0.9em; /* Más pequeño para la pregunta de abajo */
            color: #00ff00;
            margin-top: 8px; /* Reducir margen superior */
            min-height: 2em; /* Mantener para evitar saltos si el texto es corto */
            max-width: 90%;
            text-align: center;
            padding: 0 5px;
            box-sizing: border-box;
        }

        /* Importar fuente de Google Fonts para estilo retro */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    </style>
</head>
<body>
    <h1>Serpiente Sabia 2D</h1>

    <div id="start-screen">
        <h2>Bienvenido a Serpiente Sabia</h2>
        <p>Ingresa tu nombre para comenzar:</p>
        <input type="text" id="student-name-input" placeholder="Tu nombre" maxlength="20">
        <p>Selecciona tu grado:</p>
        <select id="grade-selection">
            <option value="grado7">Grado 7</option>
            <option value="grado8">Grado 8</option>
            <option value="grado9">Grado 9</option>
        </select>
        <button id="start-game-button">¡Empezar a Jugar!</button>
    </div>

    <div id="initial-instructions-overlay">
        <p class="instructions-title">Instrucciones del Juego</p>
        <p>Mueve la serpiente con las **flechas del teclado** (PC) o **deslizando el dedo** en cualquier parte de la pantalla (móvil).</p>
        <p>Cuando aparezca una pregunta, busca la respuesta:</p>
        <p>• **Círculo rojo** = Verdadero</p>
        <p>• **Cuadrado gris** = Falso</p>
        <p>Responde bien para crecer. ¡Evita chocar!</p>
        <button id="begin-game-button">Toca aquí para empezar</button>
    </div>

    <div id="game-header">
        <p id="instructions">Desliza el dedo para mover. Come el **círculo rojo** (Verdadero) o el **cuadrado gris** (Falso).</p>
        <div id="score-level-bar">
            <p id="student-name-display"></p> <p id="score">Puntaje: 0</p>
            <p id="level">Nivel: 1</p>
        </div>
    </div>

    <canvas id="game" width="400" height="400"></canvas>

    <div id="question-overlay">
        <p id="overlay-question-text"></p>
        <p id="overlay-timer-text"></p>
    </div>

    <p id="current-question-display"></p>

    <div id="game-over-screen">
        <h2 id="game-over-title">¡Juego Terminado!</h2>
        <p id="final-score">Puntaje final: 0</p>
        <button id="restart-button">Jugar de Nuevo</button>
    </div>

    <script>
        // --- PREGUNTAS POR GRADO Y NIVEL ---
        const preguntasPorGrado = {
            "grado7": {
                1: [
                    { texto: "¿La descripción inicial del notario Utterson sugiere que es un hombre extrovertido y de emociones fácilmente expresables?", respuesta: false },
                    { texto: "¿La historia que cuenta Enfield sobre la puerta y el incidente con la niña implica que el personaje de Hyde es percibido como inofensivo por quienes lo encuentran?", respuesta: false },
                    { texto: "¿La descripción de la casa conectada a la puerta, con su aspecto cuidado, contrasta directamente con la apariencia deteriorada de la puerta en sí misma?", respuesta: true },
                    { texto: "¿La incapacidad de Enfield para describir concretamente a Hyde, más allá de una 'fuerte sensación de deformidad', indica que su recuerdo del hombre es vago e impreciso?", respuesta: false },
                    { texto: "¿El pacto final propuesto por Enfield al final del capítulo implica que ambos hombres han decidido ignorar por completo el misterio que rodea a Hyde?", respuesta: true },
                    { texto: "¿El desagrado que Utterson sentía por Hyde era tan profunda que no podía explicarse solo por los rasgos físicos negativos que observó en él?", respuesta: true },
                    { texto: "¿Antes de que Utterson le preguntara, Lanyon ya había escuchado el nombre de Hyde?", respuesta: false },
                    { texto: "¿En sus sueños, Utterson sentía una curiosidad muy fuerte e irresistible por conocer el rostro de Hyde?", respuesta: true },
                    { texto: "¿El testamento de Jekyll establecía que Hyde tomaría posesión de sus bienes si el doctor desaparecía por un periodo superior a tres meses?", respuesta: true },
                    { texto: "¿Utterson consideró que no tenía ninguna culpa en su pasado al analizarlo?", respuesta: false }
                ],
                2: [
                    { texto: "¿El doctor Jekyll y Utterson eran viejos compañeros, como se indica en el texto?", respuesta: true },
                    { texto: "¿Al inicio de la conversación, el doctor Jekyll mostró muchas ganas de hablar sobre el tema de Hyde?", respuesta: false },
                    { texto: "¿Jekyll afirmó que él podía librarse de Hyde en cualquier momento que quisiera?", respuesta: true },
                    { texto: "¿Jekyll insistió en que Utterson debía dejar de investigar a Hyde?", respuesta: true },
                    { texto: "¿Jekyll parecía completamente tranquilo y en paz al hablar de Hyde?", respuesta: false },
                    { texto: "¿Utterson se llevó un gran alivio después de hablar con Jekyll sobre Hyde?", respuesta: false },
                    { texto: "¿La descripción del comportamiento de Jekyll al inicio del capítulo implica que estaba actuando de manera normal y despreocupada?", respuesta: false },
                    { texto: "¿Se puede inferir que Utterson sospechaba que Jekyll estaba ocultando algo, incluso después de su conversación?", respuesta: true },
                    { texto: "¿La reacción de Jekyll ante las preguntas de Utterson fue de total cooperación y transparencia?", respuesta: false },
                    { texto: "¿La frase '¡Esto es una cuestión de mi vida o de mi muerte!' indica la extrema importancia de la relación de Jekyll con Hyde?", respuesta: true }
                ],
                3: [
                    { texto: "¿La sirvienta que presenció el asesinato de Sir Danvers Carew estaba dormida en el momento del crimen?", respuesta: false },
                    { texto: "¿El asesinato de Carew ocurrió al atardecer, bajo una luna llena?", respuesta: false },
                    { texto: "¿La sirvienta describió al asesino como un hombre de baja estatura y aspecto despreciable?", respuesta: true },
                    { texto: "¿El arma utilizada en el asesinato fue una pistola?", respuesta: false },
                    { texto: "¿Utterson reconoció el arma como el bastón que le había regalado a Jekyll?", respuesta: true },
                    { texto: "¿El doctor Jekyll parecía profundamente afectado por la noticia del asesinato de Carew?", respuesta: true },
                    { texto: "¿Jekyll le entregó una carta a Utterson, afirmando que había sido escrita por Hyde?", respuesta: true },
                    { texto: "¿Utterson creyó la historia de Jekyll sobre la carta sin ninguna duda?", respuesta: false },
                    { texto: "¿Poole le confirmó a Utterson que ningún mensajero había traído la carta a la casa de Jekyll?", respuesta: true },
                    { texto: "¿El experto en escritura que Utterson consultó afirmó que las dos cartas (la de Jekyll y la supuestamente de Hyde) eran idénticas?", respuesta: false }
                ],
                4: [
                    { texto: "¿La relación entre Jekyll y Lanyon había sido siempre de gran amistad y cercanía?", respuesta: false },
                    { texto: "¿Después del incidente de Carew, Jekyll se volvió más sociable y activo en la vida pública?", respuesta: false },
                    { texto: "¿La salud de Lanyon comenzó a deteriorarse rápidamente después de una conversación con Jekyll?", respuesta: true },
                    { texto: "¿Lanyon se negó a hablar de Jekyll con Utterson, alegando que había tenido un 'shock fatal'?", respuesta: true },
                    { texto: "¿Lanyon le dio a Utterson un sobre sellado con instrucciones de abrirlo solo después de la muerte o desaparición de Jekyll?", respuesta: true },
                    { texto: "¿Utterson leyó el contenido del sobre de Lanyon inmediatamente después de recibirlo?", respuesta: false },
                    { texto: "¿La muerte de Lanyon fue un shock para Utterson, quien lo consideraba un hombre fuerte y saludable?", respuesta: true },
                    { texto: "¿El capítulo sugiere que la 'muerte' de la amistad entre Jekyll y Lanyon fue tan significativa como la muerte física de Lanyon?", respuesta: true },
                    { texto: "¿Utterson, al recibir la carta de Lanyon, sintió una gran curiosidad por saber su contenido, pero se contuvo?", respuesta: true },
                    { texto: "¿La actitud de Lanyon hacia Jekyll se volvió más comprensiva y menos crítica después de su último encuentro?", respuesta: false }
                ],
                5: [
                    { texto: "¿Utterson y Enfield comenzaron a dar sus paseos semanales por el mismo lugar de siempre?", respuesta: false },
                    { texto: "¿Ambos hombres evitaron a toda costa la puerta que los recordaba a Hyde?", respuesta: true },
                    { texto: "¿Enfield sugirió que deberían dejar de hablar de Jekyll y Hyde?", respuesta: true },
                    { texto: "¿El comportamiento de Jekyll en la ventana fue de total tranquilidad y alegría?", respuesta: false },
                    { texto: "¿Utterson y Enfield pudieron ver claramente la transformación de Jekyll en la ventana?", respuesta: false },
                    { texto: "¿La repentina desaparición de Jekyll de la ventana fue percibida como un evento sobrenatural por Utterson?", respuesta: true },
                    { texto: "¿Utterson sintió un 'horror helado' al ver la expresión de Jekyll?", respuesta: true },
                    { texto: "¿Enfield sugirió que deberían visitar a Jekyll después de lo que vieron?", respuesta: false },
                    { texto: "¿El episodio de la ventana solidificó la creencia de Utterson de que algo terrible le estaba ocurriendo a Jekyll?", respuesta: true },
                    { texto: "¿La frase 'Dios nos perdone' dicha por Utterson, indica la gravedad de la situación que presenciaron?", respuesta: true }
                ],
                6: [
                    { texto: "¿Poole estaba preocupado por el doctor Jekyll por la forma en que lo describió y su insistencia en buscar ayuda?", respuesta: true },
                    { texto: "¿La actitud de Poole al describir la voz de la persona en el laboratorio sugiere que creía que Jekyll simplemente estaba enfermo y no era otra persona?", respuesta: false },
                    { texto: "¿El doctor Lanyon recibió una carta certificada de su colega Henry Jekyll el nueve de enero?", respuesta: true },
                    { texto: "¿El doctor Jekyll le pidió a Lanyon que fuera a su casa en taxi para recoger algo de su cuarto de trabajo?", respuesta: true },
                    { texto: "¿Poole le entregó un cajón con varios frascos y papeles al doctor Lanyon?", respuesta: true },
                    { texto: "¿Se puede inferir que el doctor Jekyll le estaba pidiendo a Lanyon que hiciera algo en contra de sus principios éticos al inicio de la carta?", respuesta: true },
                    { texto: "¿La descripción de la transformación que Lanyon presenció es tan vaga que no permite formarse una idea clara de lo que sucedió?", respuesta: false },
                    { texto: "¿El doctor Jekyll nació con una inclinación natural a la laboriosidad y una ambición por la estima de los demás?", respuesta: true },
                    { texto: "¿El doctor Jekyll creía que la separación del bien y el mal en el hombre era una ley fundamental de la vida?", respuesta: true },
                    { texto: "¿Jekyll explica en su confesión que no había experimentado el cambio completo a Hyde antes del incidente de la carta con Lanyon?", respuesta: false },
                    { texto: "¿Se puede inferir que la transformación en Hyde le ofrecía a Jekyll una liberación de las restricciones sociales y morales de su época llamada?", respuesta: true },
                    { texto: "¿El relato de Jekyll sugiere que la dualidad humana, la coexistencia del bien y el mal en una misma persona, es el tema central de la novela?", respuesta: true }
                ]
            },
            "grado8": {
                1: [
                    { texto: "¿La frase 'Bastará decir que soy Juan Pablo Castel, el pintor que mató a María Iribarne' revela de inmediato el desenlace trágico de la historia.", respuesta: true },
                    { texto: "¿La justificación de Castel para escribir su historia, atribuyéndola a la vanidad humana, refuerza su imagen como un individuo modesto y sin pretensiones.", respuesta: false },
                    { texto: "¿Cuando Castel afirma que 'los criminales son gente más limpia', está sugiriendo que sus acciones son moralmente superiores a las 'bajezas' cotidianas de la sociedad.", respuesta: true },
                    { texto: "¿La 'débil esperanza' de Castel de ser comprendido por alguien, a pesar de su escepticismo, indica una contradicción en su misantropía.", respuesta: true },
                    { texto: "¿La ausencia de la mujer en la inauguración de la exposición, después de su primera aparición, calma las ansiedades de Castel, al confirmar que nadie más la notó.", respuesta: false },
                    { texto: "¿La obsesión de Castel con la mujer que miraba su cuadro, sugiere una profunda conexión intelectual que trasciende lo meramente físico.", respuesta: true },
                    { texto: "¿La aversión de Castel hacia los grupos y las sectas es un rasgo menor de su personalidad que no influye en su visión del mundo.", respuesta: false },
                    { texto: "¿El desprecio de Castel por los críticos de arte se basa en su creencia de que solo él posee la verdadera comprensión del arte.", respuesta: true },
                    { texto: "¿La anécdota de Castel y el ciego sirve para ilustrar la facilidad con la que Castel establece conexiones significativas con otras personas.", respuesta: false },
                    { texto: "¿La incapacidad de Castel para mantener un diálogo coherente con el ciego demuestra su profunda soledad y dificultad para la comunicación.", respuesta: true }
                ],
                2: [
                    { texto: "¿La frase 'Bastará decir que soy Juan Pablo Castel, el pintor que mató a María Iribarne' revela de inmediato el desenlace trágico de la historia.", respuesta: true },
                    { texto: "¿La justificación de Castel para escribir su historia, atribuyéndola a la vanidad humana, refuerza su imagen como un individuo modesto y sin pretensiones.", respuesta: false },
                    { texto: "¿Cuando Castel afirma que 'los criminales son gente más limpia', está sugiriendo que sus acciones son moralmente superiores a las 'bajezas' cotidianas de la sociedad.", respuesta: true },
                    { texto: "¿La 'débil esperanza' de Castel de ser comprendido por alguien, a pesar de su escepticismo, indica una contradicción en su misantropía.", respuesta: true },
                    { texto: "¿La ausencia de la mujer en la inauguración de la exposición, después de su primera aparición, calma las ansiedades de Castel, al confirmar que nadie más la notó.", respuesta: false },
                    { texto: "¿La obsesión de Castel con la mujer que miraba su cuadro, sugiere una profunda conexión intelectual que trasciende lo meramente físico.", respuesta: true },
                    { texto: "¿La aversión de Castel hacia los grupos y las sectas es un rasgo menor de su personalidad que no influye en su visión del mundo.", respuesta: false },
                    { texto: "¿El desprecio de Castel por los críticos de arte se basa en su creencia de que solo él posee la verdadera comprensión del arte.", respuesta: true },
                    { texto: "¿La anécdota de Castel y el ciego sirve para ilustrar la facilidad con la que Castel establece conexiones significativas con otras personas.", respuesta: false },
                    { texto: "¿La incapacidad de Castel para mantener un diálogo coherente con el ciego demuestra su profunda soledad y dificultad para la comunicación.", respuesta: true }
                ],
                3: [
                    { texto: "¿El encuentro de Castel con María Iribarne en la playa, donde ella está atenta a sus explicaciones, lo hace sentirse comprendido y esperanzado?", respuesta: true },
                    { texto: "¿Castel describe a María como una persona con una inteligencia y una sensibilidad extraordinarias, que lo atraen profundamente?", respuesta: true },
                    { texto: "¿La decisión de Castel de seguir a María hasta la estancia es un impulso irracional que no tiene ninguna justificación lógica en su mente?", respuesta: false },
                    { texto: "¿El 'odio violento' que Castel experimenta hacia María mientras ella está durmiendo, se explica por una traición anterior de ella hacia él?", respuesta: false },
                    { texto: "¿La confesión de Castel sobre su 'debilidad por las prostitutas' se presenta como una justificación de su inestabilidad emocional?", respuesta: true },
                    { texto: "¿La casa de María, en la que viven otros parientes, representa para Castel un refugio de la soledad y un lugar de pertenencia?", respuesta: false },
                    { texto: "¿La relación entre Castel y el marido de María, Allende, se describe como una de respeto mutuo y entendimiento cordial?", respuesta: false },
                    { texto: "¿Castel percibe las visitas de María a su estudio como un signo inequívoco de su amor y devoción hacia él?", respuesta: false },
                    { texto: "¿El temor de Castel a que María esté 'engañando' lo consume y lo lleva a una espiral de paranoia y celos?", respuesta: true },
                    { texto: "¿La frase 'un túnel oscuro' que describe la visión de Castel sobre el futuro, simboliza su desesperanza y su aislamiento creciente?", respuesta: true }
                ],
                4: [
                    { texto: "¿La confrontación de Castel con Hunter en el estudio de María confirma las sospechas de Castel sobre la infidelidad de María?", respuesta: true },
                    { texto: "¿La 'visita' de María al estudio de Castel, antes de su muerte, se presenta como un intento de reconciliación y de aclarar los malentendidos?", respuesta: false },
                    { texto: "¿Castel interpreta la llegada de María a su estudio en ese momento como una burla final a su obsesión?", respuesta: true },
                    { texto: "¿La acción de María de intentar quemar el cuadro de Castel es una señal de su profundo desprecio por su arte?", respuesta: true },
                    { texto: "¿La descripción del grito de Castel antes del asesinato de María sugiere un momento de lucidez y de arrepentimiento por sus acciones?", respuesta: false },
                    { texto: "¿El hecho de que la luz del dormitorio de María no se encienda después de la de Hunter calma las ansiedades de Castel y le da una sensación de alivio sobre la relación de María con Hunter?", respuesta: false },
                    { texto: "¿El asesinato de María es el resultado de un plan premeditado y lógico de Castel, que culmina sus razonamientos sobre la infidelidad de ella?", respuesta: true },
                    { texto: "¿La confesión de Castel a Allende sobre la infidelidad de María es recibida por el ciego con sorpresa e incredulidad, pero sin una reacción violenta?", respuesta: false },
                    { texto: "¿La frase 'Solo existió un ser que entendía mi pintura', dicha por Castel en el calabozo, se refiere a alguien diferente de María?", respuesta: false },
                    { texto: "¿La 'caverna negra' que se agranda dentro del cuerpo de Castel al final del libro, puede interpretarse como la consumación de su aislamiento, liberándolo de las expectativas de conexión con el mundo exterior?", respuesta: true },
                    { texto: "¿La incapacidad de Castel para razonar sobre la palabra 'insensato' del ciego al final del libro señala una resistencia a la autocrítica que, en su lógica distorsionada, le permite mantener su visión de la realidad sin cuestionar su propia culpabilidad?", respuesta: true },
                    { texto: "¿El hecho de que Castel siga pintando en el encierro significa que ha encontrado una forma de redención o de escapar de su tormento interno?", respuesta: false },
                    { texto: "¿El final del libro implica una resolución clara de los conflictos de Castel y una comprensión de su destino por parte del lectorStamped:false}", respuesta: false },
                    { texto: "¿El tema central del libro, tal como se infiere del fragmento final, es el amor romántico y la búsqueda de la felicidad en una relación de pareja?", respuesta: false }
                ]
            },
            "grado9": {
                1: [
                    { texto: "¿Alexander Coid se despertó al amanecer por una pesadilla?", respuesta: true },
                    { texto: "¿Soñaba Alex que un enorme perro negro se llevaba a su madre?", respuesta: false },
                    { texto: "¿El perro de Alex, Poncho, había sido mordido por un venado?", respuesta: true },
                    { texto: "¿La madre de Alex se afeitó el cabello por gusto?", respuesta: false },
                    { texto: "¿Alex rompió sus pertenencias en la habitación de sus padres?", respuesta: false },
                    { texto: "¿El padre de Alex le dijo que iría al Amazonas solo?", respuesta: true },
                    { texto: "¿Alex estaba emocionado de ir al Amazonas con su abuela Kate?", respuesta: false },
                    { texto: "¿Morgana le robó la cartera a Alex en el bus?", respuesta: true },
                    { texto: "¿Alex creía que el Amazonas estaba lleno de mosquitos y enfermedades?", respuesta: true },
                    { texto: "¿La abuela Kate le enseñó a Alex a fumar para que le dejara de gustar?", respuesta: true }
                ],
                2: [
                    { texto: "¿'Quien boca tiene, a Roma llega' era uno de los axiomas de Kate Coid?", respuesta: true },
                    { texto: "¿Alex era un muchacho tímido y le costaba abordar a desconocidos?", respuesta: true },
                    { texto: "¿Alex consideró que las instrucciones del empleado del restaurante eran fáciles de entender?", respuesta: false },
                    { texto: "¿El hombre que masticaba una hamburguesa le dio a Alex instrucciones claras para llegar a la calle Catorce con la Segunda Avenida?", respuesta: false },
                    { texto: "¿Alex consideró que caminar unas pocas cuadras por terreno plano era más difícil que escalar montañas?", respuesta: false },
                    { texto: "¿El sacerdote afirmó que los indios eran primitivos en lo material pero avanzados en el plano mental?", respuesta: true },
                    { texto: "¿El padre Valdomero vio a la Bestia hace solo unos meses?", respuesta: false },
                    { texto: "¿La Bestia que vio el padre Valdomero medía menos de dos metros?", respuesta: false },
                    { texto: "¿Las huellas que encontró el padre Valdomero eran similares a las de un gorila?", respuesta: true },
                    { texto: "¿El padre Valdomero creía que la Bestia era un animal común y corriente?", respuesta: false }
                ],
                3: [
                    { texto: "¿El profesor Leblanc consideraba a Nadia Santos una alumna excepcional?", respuesta: true },
                    { texto: "¿Nadia Santos había viajado por todo el mundo antes de la expedición?", respuesta: true },
                    { texto: "¿Nadia se preocupaba mucho por las opiniones de los demás?", respuesta: false },
                    { texto: "¿Nadia era capaz de comunicarse con los animales?", respuesta: true },
                    { texto: "¿Nadia y Alex tenían la misma edad?", respuesta: false },
                    { texto: "¿La doctora Omayra Torres se llevaba muy bien con Nadia?", respuesta: false },
                    { texto: "¿Mauro Carías era el director de la expedición al Amazonas?", respuesta: true },
                    { texto: "¿El grupo buscaba una criatura legendaria en el Amazonas?", respuesta: true },
                    { texto: "¿La expedición tenía el apoyo total del gobierno brasileño?", respuesta: false },
                    { texto: "¿Nadia sentía un gran respeto por las tradiciones indígenas?", respuesta: true }
                ],
                4: [
                    { texto: "¿La tribu de los 'Hombres de la Niebla' era conocida por su hospitalidad?", respuesta: false },
                    { texto: "¿El jefe de la tribu, Walimaí, recibió al grupo con alegría?", respuesta: false },
                    { texto: "¿Nadia y Alex fueron los primeros en establecer contacto con la tribu?", respuesta: true },
                    { texto: "¿La tribu vivía en un lugar de difícil acceso, en la cima de un tepuy?", respuesta: true },
                    { texto: "¿Los indígenas ofrecieron comida y refugio al grupo de expedición?", respuesta: false },
                    { texto: "¿Karakawe era un chamán de la tribu que se opuso a la presencia de los 'nahab'?", respuesta: true },
                    { texto: "¿La 'gente invisible' era un mito entre la tribu?", respuesta: false },
                    { texto: "¿El tepuy sagrado era un lugar al que cualquier forastero podía acceder?", respuesta: false },
                    { texto: "¿El grupo de expedición intentó imponer sus costumbres a la tribu?", respuesta: true },
                    { texto: "¿Nadia y Alex se ganaron la confianza de algunos miembros de la tribu?", respuesta: true }
                ],
                5: [
                    { texto: "¿El chamán Karakawe creía que el sarampión podía matar a la tribu si no se vacunaban?", respuesta: true },
                    { texto: "¿Nadia y Alex contaron todo lo que sabían sobre el tepui sagrado a Mauro Carías y los militares?", respuesta: false },
                    { texto: "¿Iyomi aceptó sin discutir que los nahab vacunaran a su gente?", respuesta: false },
                    { texto: "¿Karakawe denunció a Mauro Carías y a la doctora Torres frente al grupo?", respuesta: true },
                    { texto: "¿El capitán Ariosto disparó a Karakawe después de su denuncia?", respuesta: true },
                    { texto: "¿Mauro Carías destruyó las vacunas para evitar que fueran examinadas?", respuesta: true },
                    { texto: "¿La doctora Omayra Torres mostró señales de arrepentimiento por su complicidad en el plan de exterminio?", respuesta: false },
                    { texto: "¿Alexander fue atado a un árbol como castigo por parte de Ariosto?", respuesta: true },
                    { texto: "¿Al final del fragmento la expedición está a salvo y en control de la situación?", respuesta: false },
                    { texto: "¿Nadia logró salir del campamento sin ser vista por los soldados?", respuesta: true },
                    { texto: "¿Walimaí liberó a Alexander de las ataduras con una navaja?", respuesta: true },
                    { texto: "¿La Bestia atacó físicamente al capitán Ariosto con sus garras?", respuesta: true },
                    { texto: "¿Los soldados fueron testigos conscientes del ataque de las BestiasStamped:false}", respuesta: false },
                    { texto: "¿Iyomi dio permiso para que la tribu se vacunara?", respuesta: true },
                    { texto: "¿Los indígenas sabían que los frascos contenían un virus antes de que murieran algunos?", respuesta: false },
                    { texto: "¿La presencia de Nadia ayudó a mejorar la comunicación entre los nahab y los indígenas?", respuesta: true },
                    { texto: "¿Las Bestias fueron utilizadas para castigar tanto a enemigos como a amigos?", respuesta: true }
                ]
            }
        };

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const questionOverlay = document.getElementById("question-overlay");
        const overlayQuestionText = document.getElementById("overlay-question-text");
        const overlayTimerText = document.getElementById("overlay-timer-text");
        const currentQuestionDisplay = document.getElementById("current-question-display");
        const scoreDisplay = document.getElementById("score");
        const levelDisplay = document.getElementById("level");
        const gameOverScreen = document.getElementById("game-over-screen");
        const gameOverTitle = document.getElementById("game-over-title");
        const finalScoreDisplay = document.getElementById("final-score");
        const restartButton = document.getElementById("restart-button");
        const instructionsDisplay = document.getElementById("instructions"); // Elemento para instrucciones generales

        // Elementos de la pantalla de inicio
        const startScreen = document.getElementById("start-screen");
        const studentNameInput = document.getElementById("student-name-input");
        const gradeSelection = document.getElementById("grade-selection");
        const startGameButton = document.getElementById("start-game-button");
        const studentNameDisplay = document.getElementById("student-name-display");

        // Overlay de instrucciones iniciales
        const initialInstructionsOverlay = document.getElementById("initial-instructions-overlay");
        // Botón dentro del overlay de instrucciones (renombrado para consistencia)
        const beginGameButton = document.getElementById("begin-game-button");


        const box = 20;
        let snake = [];
        let direction = null;
        let food = {}; // Manzana (Verdadero)
        let rat = {}; // Ratón (Falso)
        let score = 0;
        let level = 1;
        let gameSpeed = 200; // Velocidad inicial más lenta
        let selectedGradeQuestions = {};
        let studentName = ""; // Variable para almacenar el nombre del estudiante

        let currentLevelQuestions = [];

        let currentQuestion = null;

        let gamePausedForQuestion = true; // Para pausar durante la pregunta en overlay
        let overlayQuestionTimerInterval;
        let overlayTimeLeft = 0;
        const OVERLAY_QUESTION_DURATION = 8;

        let animationFrameId;
        let lastFrameTime = 0;
        let targetFrameRate;

        const QUESTIONS_TO_LEVEL_UP = 3;
        let questionsCorrectInCycle = 0;
        let questionsAnsweredInCycle = 0;
        let segmentsToAdd = 0;

        // Cola de movimientos para manejar entradas rápidas
        let moveQueue = [];

        // Variables para detección de gestos táctiles
        let touchStartX = 0;
        let touchStartY = 0;
        const SWIPE_THRESHOLD = 15; // Reducido para respuesta más rápida
        let touchStartTime = 0;

        // Variables para detección de gestos con el mouse (para PC sin touch)
        let mouseIsDown = false;
        let mouseStartX = 0;
        let mouseStartY = 0;

        // --- Detección de dispositivo táctil (para adaptar texto de instrucciones) ---
        function isTouchDevice() {
            return (('ontouchstart' in window) ||
                    (navigator.maxTouchPoints > 0) ||
                    (navigator.msMaxTouchPoints > 0));
        }
        const isMobile = isTouchDevice(); // Determinado una vez al cargar la página

        // --- FUNCIONES DE UTILIDAD ---
        function randomPosition() {
            let pos;
            const forbiddenPositions = new Set();
            for (let i = 0; i < snake.length; i++) {
                forbiddenPositions.add(`${snake[i].x},${snake[i].y}`);
            }
            if (food.x !== undefined) forbiddenPositions.add(`${food.x},${food.y}`);
            if (rat.x !== undefined) forbiddenPositions.add(`${rat.x},${rat.y}`);

            let attempts = 0;
            const maxAttempts = 100;
            do {
                pos = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box,
                };
                attempts++;
            } while (forbiddenPositions.has(`${pos.x},${pos.y}`) && attempts < maxAttempts);

            if (attempts >= maxAttempts) {
                console.warn("No se pudo encontrar una posición libre para la comida/ratón. Considera un mapa más grande o menos segmentos de serpiente.");
            }
            return pos;
        }

        function collision(head, array, checkAllSegments = false) {
            const startIndex = checkAllSegments ? 0 : 1;
            for (let i = startIndex; i < array.length; i++) {
                if (head.x === array[i].x && head.y === array[i].y) {
                    return true;
                }
            }
            return false;
        }

        // --- FUNCIÓN PARA AJUSTAR TAMAÑO DEL CANVAS EN MÓVILES ---
        function adjustCanvasSize() {
            const maxWidth = Math.min(400, window.innerWidth * 0.95);
            const maxHeight = Math.min(400, window.innerHeight * 0.6);

            // Mantener proporción cuadrada
            const size = Math.min(maxWidth, maxHeight);

            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';

            // Mantener la resolución interna del canvas
            canvas.width = 400;
            canvas.height = 400;
        }

        // --- INICIALIZACIÓN DEL JUEGO ---
        function initGame() {
            console.log("--- INICIO: Iniciando Juego ---");
            stopAnimationFrameLoop();
            clearInterval(overlayQuestionTimerInterval);
            adjustCanvasSize();

            const selectedGrade = gradeSelection.value;
            selectedGradeQuestions = {};
            for (const lvl in preguntasPorGrado[selectedGrade]) {
                selectedGradeQuestions[lvl] = [...preguntasPorGrado[selectedGrade][lvl]];
            }

            snake = [{ x: 9 * box, y: 10 * box }];
            direction = null;
            moveQueue = [];
            score = 0;
            level = 1;
            gameSpeed = 200;
            targetFrameRate = 1000 / (1000 / gameSpeed);
            questionsCorrectInCycle = 0;
            questionsAnsweredInCycle = 0;
            segmentsToAdd = 0;
            currentQuestion = null;
            food = {};
            rat = {};
            gamePausedForQuestion = true;

            scoreDisplay.innerText = "Puntaje: " + score;
            levelDisplay.innerText = "Nivel: " + level;
            gameOverScreen.style.display = "none";
            currentQuestionDisplay.innerText = "";
            gameOverTitle.innerText = "";
            finalScoreDisplay.innerText = "";

            studentNameDisplay.innerText = studentName ? `Jugador: ${studentName}` : "";

            // Ocultar overlays y mostrar elementos del juego
            startScreen.style.display = "none";
            initialInstructionsOverlay.style.display = "none"; // Asegurarse de ocultarlo
            canvas.style.display = "block";
            currentQuestionDisplay.style.display = "block";

            drawInitialState();

            loadLevelQuestionsForCurrentLevel();
            presentQuestion();
            console.log("INICIO: initGame finalizado. Esperando primera pregunta para iniciar bucle.");
        }

        function drawInitialState() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "lime" : "green";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
            }
        }

        // --- Gestión de la Pantalla de Inicio y Instrucciones ---
        function showStartScreen() {
            console.log("ESTADO: Mostrando pantalla de inicio.");
            startScreen.style.display = "flex";
            canvas.style.display = "none";
            questionOverlay.style.display = "none";
            initialInstructionsOverlay.style.display = "none";
            currentQuestionDisplay.style.display = "none";
            gameOverScreen.style.display = "none";

            // Limpiar listeners antiguos para evitar duplicados
            startGameButton.removeEventListener('click', handleStartGameButtonClick);
            studentNameInput.removeEventListener('keypress', handleNameInputKeyPress);

            // AÑADIDO: Limpiar listeners del botón de inicio del overlay por si acaso
            beginGameButton.removeEventListener("click", startActualGame);

            startGameButton.addEventListener('click', handleStartGameButtonClick);
            studentNameInput.addEventListener('keypress', handleNameInputKeyPress);
            studentNameInput.focus();
        }

        function handleNameInputKeyPress(event) {
            if (event.key === 'Enter') {
                handleStartGameButtonClick();
            }
        }

        function handleStartGameButtonClick() {
            const name = studentNameInput.value.trim();
            if (name === "") {
                alert("Por favor, ingresa tu nombre para empezar.");
                return;
            }
            studentName = name; // Guardar el nombre

            console.log("ESTADO: Mostrando overlay de instrucciones iniciales.");
            startScreen.style.display = "none"; // Ocultar pantalla de inicio
            initialInstructionsOverlay.style.display = "flex"; // Mostrar instrucciones

            // AHORA: El botón dentro del overlay de instrucciones es el que inicia el juego
            beginGameButton.removeEventListener("click", startActualGame); // Limpiar para evitar duplicados

            // Usar solo click event que funciona tanto en desktop como móvil
            beginGameButton.addEventListener("click", startActualGame);
        }

        

        function startActualGame() {
            console.log("INICIO: startActualGame llamado. Iniciando juego...");
            initialInstructionsOverlay.style.display = "none"; // Ocultar las instrucciones
            initGame(); // Iniciar el juego
        }

        function loadLevelQuestionsForCurrentLevel() {
            console.log(`PREGUNTAS: Cargando preguntas para Nivel ${level} del grado ${gradeSelection.value}.`);
            currentLevelQuestions = selectedGradeQuestions[level] ? [...selectedGradeQuestions[level]] : [];

            if (currentLevelQuestions.length === 0) {
                console.warn(`PREGUNTAS: No hay preguntas para el Nivel ${level} del grado ${gradeSelection.value}.`);
                if (level < Object.keys(selectedGradeQuestions).length) {
                    levelUp();
                } else {
                    endGame(true);
                }
            }
        }

        // --- LÓGICA DE PREGUNTAS Y RESPUESTAS ---
        function presentQuestion() {
            clearInterval(overlayQuestionTimerInterval);

            if (currentLevelQuestions.length === 0) {
                console.log("PREGUNTAS: No hay más preguntas disponibles en este nivel. Intentando avanzar de nivel...");
                if (level < Object.keys(selectedGradeQuestions).length) {
                    levelUp();
                    return;
                } else {
                    endGame(true);
                    return;
                }
            }

            const randomIndex = Math.floor(Math.random() * currentLevelQuestions.length);
            currentQuestion = currentLevelQuestions[randomIndex];

            console.log(`PREGUNTAS: Presentando pregunta en overlay: "${currentQuestion.texto}" (Respuesta: ${currentQuestion.respuesta ? 'Verdadero' : 'Falso'})`);

            overlayQuestionText.innerText = currentQuestion.texto;
            overlayTimeLeft = OVERLAY_QUESTION_DURATION;
            overlayTimerText.innerText = `Tiempo: ${overlayTimeLeft}s`;
            questionOverlay.classList.remove('slide-out');
            questionOverlay.style.transform = 'translate(-50%, -50%)';
            questionOverlay.style.opacity = '1';
            questionOverlay.style.display = "flex";

            gamePausedForQuestion = true;
            stopAnimationFrameLoop(); // Pausar movimiento de serpiente

            overlayQuestionTimerInterval = setInterval(() => {
                overlayTimeLeft--;
                overlayTimerText.innerText = `Tiempo: ${overlayTimeLeft}s`;

                if (overlayTimeLeft <= 0) {
                    clearInterval(overlayQuestionTimerInterval);
                    console.log("PREGUNTAS: Tiempo de overlay de pregunta terminado.");

                    questionOverlay.classList.add('slide-out');
                    setTimeout(() => {
                        questionOverlay.style.display = "none";
                    }, 500);

                    currentQuestionDisplay.innerText = currentQuestion.texto;
                    gamePausedForQuestion = false; // Reanudar el juego
                    startAnimationFrameLoop(); // Reanudar el bucle de animación
                }
            }, 1000);

            placeFoodAndRat(currentQuestion.respuesta);
        }

        function placeFoodAndRat(correctAnswerIsTrue) {
            food = randomPosition();
            rat = randomPosition();

            while (food.x === rat.x && food.y === rat.y) {
                rat = randomPosition();
            }
            console.log(`COMIDA: Manzana en (${food.x},${food.y}), Ratón en (${rat.x},${rat.y}).`);
        }

        function checkAnswer(eatenItemIsFood) {
            console.log(`RESPUESTA: Serpiente comió ${eatenItemIsFood ? 'manzana (Verdadero)' : 'ratón (Falso)'}.`);
            const isCorrect = (eatenItemIsFood === currentQuestion.respuesta);

            if (isCorrect) {
                score += 1;
                questionsCorrectInCycle++;
                segmentsToAdd += 2; // CAMBIO: AHORA SUMA 2 SEGMENTOS EN LUGAR DE 1
                console.log("RESPUESTA: ¡Correcto! Puntaje:", score);
            } else {
                segmentsToAdd = Math.max(0, segmentsToAdd - 1);
                console.log("RESPUESTA: Incorrecto. Puntaje:", score);
            }
            questionsAnsweredInCycle++;
            scoreDisplay.innerText = "Puntaje: " + score;

            const answeredQuestionIndex = currentLevelQuestions.findIndex(q => q.texto === currentQuestion.texto);
            if (answeredQuestionIndex > -1) {
                currentLevelQuestions.splice(answeredQuestionIndex, 1);
                console.log("PREGUNTAS: Pregunta eliminada. Preguntas restantes en nivel:", currentLevelQuestions.length);
            }

            food = {};
            rat = {};

            gamePausedForQuestion = true;
            shouldPresentNewQuestion = true;
            checkAndPresentQuestion();
        }

        let shouldPresentNewQuestion = false;

        function checkAndPresentQuestion() {
            if (shouldPresentNewQuestion) {
                shouldPresentNewQuestion = false;
                currentQuestionDisplay.innerText = "Preparando nueva pregunta...";

                setTimeout(() => {
                    if (questionsAnsweredInCycle >= QUESTIONS_TO_LEVEL_UP) {
                        console.log("NIVEL: Intentando subir de nivel...");
                        if (level < Object.keys(selectedGradeQuestions).length) {
                            levelUp();
                            return;
                        } else {
                            endGame(true);
                            return;
                        }
                    }
                    presentQuestion();
                }, 1000);
            }
        }

        function levelUp() {
            level++;
            gameSpeed = Math.max(50, gameSpeed - 25);
            targetFrameRate = 1000 / (1000 / gameSpeed);
            levelDisplay.innerText = "Nivel: " + level;
            questionsCorrectInCycle = 0;
            questionsAnsweredInCycle = 0;
            shouldPresentNewQuestion = false;
            console.log(`NIVEL: ¡Subiste al Nivel ${level}! Velocidad: ${gameSpeed}ms.`);
            loadLevelQuestionsForCurrentLevel();
            currentQuestionDisplay.innerText = `¡Nivel ${level} alcanzado!`;
            setTimeout(() => {
                currentQuestionDisplay.innerText = "";
                presentQuestion();
            }, 1500);
        }

        // --- BUCLE PRINCIPAL DEL JUEGO (requestAnimationFrame) ---
        function gameLoop(currentTime) {
            animationFrameId = requestAnimationFrame(gameLoop);

            const elapsed = currentTime - lastFrameTime;
            if (elapsed < targetFrameRate) {
                return;
            }
            lastFrameTime = currentTime - (elapsed % targetFrameRate);

            if (gamePausedForQuestion) {
                return;
            }

            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "lime" : "green";
                ctx.strokeStyle = "darkgreen";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
                ctx.strokeRect(snake[i].x, snake[i].y, box, box);
            }

            if (food.x !== undefined) {
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(food.x + box / 2, food.y + box / 2, box / 2 - 2, 0, Math.PI * 2);
                ctx.fill();
            }

            if (rat.x !== undefined) {
                ctx.fillStyle = "gray";
                ctx.fillRect(rat.x + 2, rat.y + 2, box - 4, box - 4);
            }

            let snakeX = snake[0].x;
            let snakeY = snake[0].y;

            if (moveQueue.length > 0) {
                while (moveQueue.length > 0 && direction !== null &&
                       ((moveQueue[0] === 'LEFT' && direction === 'RIGHT') ||
                        (moveQueue[0] === 'RIGHT' && direction === 'LEFT') ||
                        (moveQueue[0] === 'UP' && direction === 'DOWN') ||
                        (moveQueue[0] === 'DOWN' && direction === 'UP'))) {
                    moveQueue.shift();
                }
                if (moveQueue.length > 0) {
                    direction = moveQueue.shift();
                }
            }


            if (direction === "LEFT") snakeX -= box;
            if (direction === "UP") snakeY -= box;
            if (direction === "RIGHT") snakeX += box;
            if (direction === "DOWN") snakeY += box;

            let newHead = { x: snakeX, y: snakeY };

            if (
                snakeX < 0 ||
                snakeX >= canvas.width ||
                snakeY < 0 ||
                snakeY >= canvas.height ||
                collision(newHead, snake)
            ) {
                endGame(false);
                return;
            }

            snake.unshift(newHead);

            let eaten = false;
            if (newHead.x === food.x && newHead.y === food.y) {
                checkAnswer(true);
                eaten = true;
            } else if (newHead.x === rat.x && newHead.y === rat.y) {
                checkAnswer(false);
                eaten = true;
            }

            if (!eaten && segmentsToAdd <= 0) {
                snake.pop();
            } else if (segmentsToAdd > 0) {
                segmentsToAdd--;
            }

            // Si no hay comida disponible y el juego no está pausado por pregunta, continuar movimiento
            if (food.x === undefined && rat.x === undefined && !gamePausedForQuestion) {
                // Continuar el juego normalmente sin comida hasta que se presente nueva pregunta
            }
        }


        function setSnakeDirection(newDirection) {
            // Si el juego está pausado por una pregunta, no permitir movimientos de la serpiente.
            if (gamePausedForQuestion) {
                 return;
            }

            // Si la dirección es null (primer movimiento al inicio del juego), la establece directamente
            if (direction === null) {
                direction = newDirection;
                moveQueue.push(newDirection);
                return;
            }

            // Prevenir giro de 180 grados
            if (direction !== null &&
                ((newDirection === "LEFT" && direction === "RIGHT") ||
                 (newDirection === "RIGHT" && direction === "LEFT") ||
                 (newDirection === "UP" && direction === "DOWN") ||
                 (newDirection === "DOWN" && direction === "UP"))) {
                console.log("DIRECCIÓN: Intento de giro de 180 grados ignorado.");
                return;
            }

            // Añadir el movimiento a la cola si no es el mismo que el último en cola (o si la cola está vacía)
            if (moveQueue.length === 0 || moveQueue[moveQueue.length - 1] !== newDirection) {
                moveQueue.push(newDirection);
            }
        }

        // --- CONTROL DE GAME OVER / VICTORIA ---
        function endGame(isVictory) {
            stopAnimationFrameLoop();
            clearInterval(overlayQuestionTimerInterval);
            gamePausedForQuestion = true;
            gameOverScreen.style.display = "flex";
            currentQuestionDisplay.innerText = "";
            questionOverlay.style.display = "none";
            questionOverlay.classList.remove('slide-out');
            questionOverlay.style.transform = 'translate(-50%, -50%)';
            questionOverlay.style.opacity = '1';

            // Asegurarse de ocultar las instrucciones iniciales si están visibles
            initialInstructionsOverlay.style.display = "none"; 

            if (isVictory) {
                gameOverTitle.innerText = "¡Felicidades, Juego Completado!";
                finalScoreDisplay.innerText = `¡Has respondido todas las preguntas de tu grado!\nPuntaje final: ${score}`;
            } else {
                gameOverTitle.innerText = "¡Juego Terminado!";
                finalScoreDisplay.innerText = `Puntaje final: ${score}`;
            }
        }

        // --- INICIAR / DETENER BUCLE requestAnimationFrame ---
        function startAnimationFrameLoop() {
            if (!animationFrameId) {
                lastFrameTime = performance.now();
                animationFrameId = requestAnimationFrame(gameLoop);
                console.log("ANIMACIÓN: Bucle requestAnimationFrame iniciado.");
            }
        }

        function stopAnimationFrameLoop() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                console.log("ANIMACIÓN: Bucle requestAnimationFrame detenido.");
            }
        }

        // --- EVENTO DE REINICIO ---
        restartButton.addEventListener("click", showStartScreen); // Volver a la pantalla de inicio al reiniciar

        // --- MANEJADORES DE EVENTOS DE TECLADO Y TÁCTILES ---
        // Listener de teclado para control de serpiente
        document.addEventListener("keydown", (event) => {
            let newDirection;
            switch (event.keyCode) {
                case 37: newDirection = "LEFT"; break;
                case 38: newDirection = "UP"; break;
                case 39: newDirection = "RIGHT"; break;
                case 40: newDirection = "DOWN"; break;
                default: return; // Ignorar otras teclas
            }
            setSnakeDirection(newDirection);
        });

        // --- Modified to listen to touch events on the body ---
        document.body.addEventListener('touchstart', (e) => {
            // Don't prevent default for buttons and interactive elements
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }
            // Always prevent default touch events to avoid scroll/zoom
            e.preventDefault();
            if (e.touches.length > 0) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            }
        }, { passive: false });

        document.body.addEventListener('touchmove', (e) => {
            // Don't prevent default for buttons and interactive elements
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }
            
            // Solo prevenir scroll si el juego está activo
            if (!gamePausedForQuestion) {
                e.preventDefault();
                
                // Detección de swipe durante el movimiento para respuesta más rápida
                if (e.touches.length > 0) {
                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const deltaX = currentX - touchStartX;
                    const deltaY = currentY - touchStartY;
                    const timeDiff = Date.now() - touchStartTime;
                    
                    // Si el movimiento es suficiente y rápido, procesar inmediatamente
                    if (timeDiff < 200 && (Math.abs(deltaX) > SWIPE_THRESHOLD || Math.abs(deltaY) > SWIPE_THRESHOLD)) {
                        let newDirection = null;
                        
                        if (Math.abs(deltaX) > Math.abs(deltaY)) {
                            newDirection = deltaX > 0 ? 'RIGHT' : 'LEFT';
                        } else {
                            newDirection = deltaY > 0 ? 'DOWN' : 'UP';
                        }
                        
                        if (newDirection) {
                            setSnakeDirection(newDirection);
                            console.log("EVENTO: Gesto táctil rápido detectado:", newDirection);
                            // Resetear para evitar múltiples detecciones
                            touchStartTime = 0;
                        }
                    }
                }
            }
        }, { passive: false });

        document.body.addEventListener('touchend', (e) => {
            // Don't prevent default for buttons and interactive elements
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }
            e.preventDefault();
            if (gamePausedForQuestion) return;
            if (e.changedTouches.length === 0) return;
            if (touchStartTime === 0) return; // Ya fue procesado en touchmove

            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;

            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            let newDirection = null;

            // Umbral reducido para respuesta más rápida
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
                newDirection = deltaX > 0 ? 'RIGHT' : 'LEFT';
            } else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > SWIPE_THRESHOLD) {
                newDirection = deltaY > 0 ? 'DOWN' : 'UP';
            }

            if (newDirection) {
                setSnakeDirection(newDirection);
                console.log("EVENTO: Gesto táctil detectado:", newDirection);
            }
        }, { passive: false });

        // Prevent zoom gestures with multiple touches
        document.body.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.body.addEventListener('gesturechange', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.body.addEventListener('gestureend', (e) => {
            e.preventDefault();
        }, { passive: false });

        // Mouse event handlers (for computers without touch screens or when using the mouse)
        // These listeners are only activated if isMobile is false.
        document.body.addEventListener('mousedown', (e) => {
            if (isMobile || gamePausedForQuestion) return;
            mouseIsDown = true;
            mouseStartX = e.clientX;
            mouseStartY = e.clientY;
            e.preventDefault();
        });

        document.body.addEventListener('mouseup', (e) => {
            if (!mouseIsDown || isMobile || gamePausedForQuestion) return;
            mouseIsDown = false;

            const mouseEndX = e.clientX;
            const mouseEndY = e.clientY;

            const deltaX = mouseEndX - mouseStartX;
            const deltaY = mouseEndY - mouseStartY;

            let newDirection = null;

            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
                newDirection = deltaX > 0 ? 'RIGHT' : 'LEFT';
            } else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > SWIPE_THRESHOLD) {
                newDirection = deltaY > 0 ? 'DOWN' : 'UP';
            }

            if (newDirection) {
                setSnakeDirection(newDirection);
            }
            e.preventDefault();
        });

        document.body.addEventListener('mousemove', (e) => {
            if (!mouseIsDown || isMobile || gamePausedForQuestion) return;
            e.preventDefault();
        });

        // --- MANEJAR REDIMENSIONAMIENTO DE VENTANA ---
        window.addEventListener('resize', () => {
            adjustCanvasSize();
        });

        // Manejar cambios de orientación en móviles
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                adjustCanvasSize();
            }, 100);
        });

        // --- INICIAR LA PANTALLA DE INICIO AL CARGAR LA PÁGINA ---
        window.onload = () => {
            adjustCanvasSize();
            showStartScreen();
        };

    </script>
</body>
</html>
