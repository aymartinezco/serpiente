<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Serpiente Sabia 2D</title>
    <style>
        body {
            color: white;
            font-family: 'Press Start 2P', cursive; /* Fuente pixelada para estilo retro */
            text-align: center;
            background-color: #1a1a1a; /* Fondo oscuro */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Alinea los elementos al inicio (arriba) */
            min-height: 100vh; /* Ocupa el 100% de la altura de la ventana */
            margin: 0;
            overflow: hidden; /* Ocultamos el scroll */
            padding: 5px 0; /* Pequeño padding para que el contenido no toque los bordes */
            box-sizing: border-box; /* Incluir padding en la altura total */
        }
        h1 {
            color: #00ff00; /* Verde neón para el título */
            font-size: 1.6em; /* Un poco más pequeño */
            margin-top: 5px; /* Margen superior muy reducido */
            margin-bottom: 5px;
        }
        canvas {
            background: #000;
            border: 2px solid #00ff00; /* Borde verde neón */
            display: block;
            margin: 5px auto; /* Margen vertical muy reducido */
        }
        #game-header { /* Contenedor superior para instrucciones, puntaje y nivel */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 400px; /* Ancho del canvas */
            margin-bottom: 5px;
        }
        #instructions {
            font-size: 0.7em; /* Aún más pequeño para instrucciones */
            margin-bottom: 3px; /* Reducir aún más el margen inferior */
            color: #ccc;
        }
        #score-level-bar {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Alinea verticalmente los elementos */
            width: 100%;
            font-size: 0.9em; /* Más pequeño para puntaje/nivel */
            color: #fff;
            margin-top: 0px;
            padding: 0 5px;
            box-sizing: border-box;
        }
        #score, #level, #student-name-display { /* Ajustar para el nuevo display de nombre */
            margin: 0;
        }
        #student-name-display {
            color: #ffcc00; /* Color distintivo para el nombre */
        }

        /* --- Estilos para la Pantalla de Inicio --- */
        #start-screen {
            background-color: rgba(0, 0, 0, 0.95);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; /* Para que esté por encima de todo */
            color: #00ff00;
            font-size: 1.2em;
        }
        #start-screen h2 {
            color: #00ff00;
            margin-bottom: 20px;
        }
        #start-screen p {
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        #start-screen input, #start-screen select {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #00ff00;
            background-color: #333;
            color: white;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            max-width: 250px;
        }
        #start-screen button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: 'Press Start 2P', cursive;
        }
        #start-screen button:hover {
            background-color: #00cc00;
        }

        /* --- Estilos para Botones Táctiles --- */
        #touch-controls {
            display: none; /* Oculto por defecto, se muestra con media query */
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            user-select: none; /* Prevenir selección de texto al tocar */
            -webkit-user-select: none; /* Para iOS */
            -ms-user-select: none; /* Para IE/Edge */
            -moz-user-select: none; /* Para Firefox */
            touch-action: manipulation; /* Evitar comportamientos del navegador como el zoom con doble toque */
        }

        .dpad-button {
            background-color: #004d00; /* Verde oscuro */
            color: #00ff00; /* Texto verde neón */
            border: 2px solid #00ff00;
            font-size: 2em; /* Iconos grandes */
            width: 60px; /* Botones cuadrados */
            height: 60px;
            margin: 5px; /* Espacio entre botones */
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            font-family: sans-serif; /* Usar una fuente estándar para los símbolos */
        }

        .dpad-button:active { /* Feedback al tocar */
            background-color: #00ff00;
            color: #000;
            transform: scale(0.95);
        }

        #touch-controls .horizontal-buttons {
            display: flex;
        }

        /* Media Query para mostrar botones táctiles en pantallas pequeñas */
        @media (max-width: 768px) { /* Este breakpoint se puede ajustar */
            #touch-controls {
                display: flex; /* Mostrar botones en pantallas pequeñas */
            }
            #instructions {
                font-size: 0.6em; /* Hacer las instrucciones más pequeñas para ahorrar espacio */
            }
        }


        #question-overlay { /* Caja para la pregunta central y temporizador */
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 10px; /* Reducir padding */
            max-width: 70%;
            display: none; /* Inicialmente oculto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            min-height: 100px; /* Asegurar un tamaño mínimo */
            box-sizing: border-box;
        }
        #question-overlay.slide-out {
            transform: translate(-50%, 150%);
            opacity: 0;
        }
        #overlay-question-text {
            font-size: 1em; /* Ajustar tamaño de la pregunta central */
            margin-bottom: 8px; /* Reducir margen */
            color: #fff;
        }
        #overlay-timer-text {
            font-size: 0.8em; /* Más pequeño para el temporizador */
            color: #ffcc00;
        }
        #game-over-screen {
            background-color: rgba(0, 0, 0, 0.9);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            display: none;
        }
        #game-over-screen h2 {
            color: #ff0000;
            font-size: 2.2em; /* Reducir tamaño de "Juego Terminado" */
            margin-bottom: 10px;
        }
        #game-over-screen p {
            font-size: 1.1em; /* Reducir tamaño de texto en game over */
            margin-bottom: 15px;
        }
        #restart-button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 8px 15px; /* Reducir padding del botón */
            font-size: 0.9em; /* Reducir tamaño de fuente del botón */
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #restart-button:hover {
            background-color: #00cc00;
        }
        /* Estilo para la pregunta que aparece debajo del juego */
        #current-question-display {
            font-size: 0.9em; /* Más pequeño para la pregunta de abajo */
            color: #00ff00;
            margin-top: 8px; /* Reducir margen superior */
            min-height: 2em; /* Mantener para evitar saltos si el texto es corto */
            max-width: 90%;
            text-align: center;
            padding: 0 5px;
            box-sizing: border-box;
            display: none; /* Inicialmente oculto */
        }

        /* Importar fuente de Google Fonts para estilo retro */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    </style>
</head>
<body>
    <h1>Serpiente Sabia 2D</h1>

    <div id="start-screen">
        <h2>Bienvenido a Serpiente Sabia</h2>
        <p>Ingresa tu nombre para comenzar:</p>
        <input type="text" id="student-name-input" placeholder="Tu nombre" maxlength="20">
        <p>Selecciona tu grado:</p>
        <select id="grade-selection">
            <option value="grado7">Grado 7</option>
            <option value="grado8">Grado 8</option>
            <option value="grado9">Grado 9</option>
        </select>
        <button id="start-game-button">¡Empezar a Jugar!</button>
    </div>

    <div id="game-header">
        <p id="instructions">Come el **círculo rojo** si la respuesta es **Verdadero**, o el **cuadrado gris** si es **Falso**.</p>
        <div id="score-level-bar">
            <p id="student-name-display"></p> <p id="score">Puntaje: 0</p>
            <p id="level">Nivel: 1</p>
        </div>
    </div>

    <canvas id="game" width="400" height="400"></canvas>

    <div id="touch-controls">
        <button id="up-button" class="dpad-button">⬆️</button>
        <div class="horizontal-buttons">
            <button id="left-button" class="dpad-button">⬅️</button>
            <button id="right-button" class="dpad-button">➡️</button>
        </div>
        <button id="down-button" class="dpad-button">⬇️</button>
    </div>

    <div id="question-overlay">
        <p id="overlay-question-text"></p>
        <p id="overlay-timer-text"></p>
    </div>

    <p id="current-question-display"></p>

    <div id="game-over-screen">
        <h2 id="game-over-title">¡Juego Terminado!</h2>
        <p id="final-score">Puntaje final: 0</p>
        <button id="restart-button">Jugar de Nuevo</button>
    </div>

    <script>
        // --- PREGUNTAS POR GRADO Y NIVEL ---
        const preguntasPorGrado = {
            "grado7": {
                1: [
                    { texto: "¿La descripción inicial del notario Utterson sugiere que es un hombre extrovertido y de emociones fácilmente expresables?", respuesta: false },
                    { texto: "¿La historia que cuenta Enfield sobre la puerta y el incidente con la niña implica que el personaje de Hyde es percibido como inofensivo por quienes lo encuentran?", respuesta: false },
                    { texto: "¿La descripción de la casa conectada a la puerta, con su aspecto cuidado, contrasta directamente con la apariencia deteriorada de la puerta en sí misma?", respuesta: true },
                    { texto: "¿La incapacidad de Enfield para describir concretamente a Hyde, más allá de una 'fuerte sensación de deformidad', indica que su recuerdo del hombre es vago e impreciso?", respuesta: false },
                    { texto: "¿El pacto final propuesto por Enfield al final del capítulo implica que ambos hombres han decidido ignorar por completo el misterio que rodea a Hyde?", respuesta: true },
                    { texto: "¿El desagrado que Utterson sentía por Hyde era tan profunda que no podía explicarse solo por los rasgos físicos negativos que observó en él?", respuesta: true },
                    { texto: "¿Antes de que Utterson le preguntara, Lanyon ya había escuchado el nombre de Hyde?", respuesta: false },
                    { texto: "¿En sus sueños, Utterson sentía una curiosidad muy fuerte e irresistible por conocer el rostro de Hyde?", respuesta: true },
                    { texto: "¿El testamento de Jekyll establecía que Hyde tomaría posesión de sus bienes si el doctor desaparecía por un periodo superior a tres meses?", respuesta: true },
                    { texto: "¿Utterson consideró que no tenía ninguna culpa en su pasado al analizarlo?", respuesta: false }
                ],
                2: [
                    { texto: "¿El doctor Jekyll y Utterson eran viejos compañeros, como se indica en el texto?", respuesta: true },
                    { texto: "¿Al inicio de la conversación, el doctor Jekyll mostró muchas ganas de hablar sobre el tema de Hyde?", respuesta: false },
                    { texto: "¿Jekyll afirmó que él podía librarse de Hyde en cualquier momento que quisiera?", respuesta: true },
                    { texto: "¿Jekyll insistió en que Utterson debía dejar de investigar a Hyde?", respuesta: true },
                    { texto: "¿Jekyll parecía completamente tranquilo y en paz al hablar de Hyde?", respuesta: false },
                    { texto: "¿Utterson se llevó un gran alivio después de hablar con Jekyll sobre Hyde?", respuesta: false },
                    { texto: "¿La descripción del comportamiento de Jekyll al inicio del capítulo implica que estaba actuando de manera normal y despreocupada?", respuesta: false },
                    { texto: "¿Se puede inferir que Utterson sospechaba que Jekyll estaba ocultando algo, incluso después de su conversación?", respuesta: true },
                    { texto: "¿La reacción de Jekyll ante las preguntas de Utterson fue de total cooperación y transparencia?", respuesta: false },
                    { texto: "¿La frase '¡Esto es una cuestión de mi vida o de mi muerte!' indica la extrema importancia de la relación de Jekyll con Hyde?", respuesta: true }
                ],
                3: [
                    { texto: "¿La sirvienta que presenció el asesinato de Sir Danvers Carew estaba dormida en el momento del crimen?", respuesta: false },
                    { texto: "¿El asesinato de Carew ocurrió al atardecer, bajo una luna llena?", respuesta: false },
                    { texto: "¿La sirvienta describió al asesino como un hombre de baja estatura y aspecto despreciable?", respuesta: true },
                    { texto: "¿El arma utilizada en el asesinato fue una pistola?", respuesta: false },
                    { texto: "¿Utterson reconoció el arma como el bastón que le había regalado a Jekyll?", respuesta: true },
                    { texto: "¿El doctor Jekyll parecía profundamente afectado por la noticia del asesinato de Carew?", respuesta: true },
                    { texto: "¿Jekyll le entregó una carta a Utterson, afirmando que había sido escrita por Hyde?", respuesta: true },
                    { texto: "¿Utterson creyó la historia de Jekyll sobre la carta sin ninguna duda?", respuesta: false },
                    { texto: "¿Poole le confirmó a Utterson que ningún mensajero había traído la carta a la casa de Jekyll?", respuesta: true },
                    { texto: "¿El experto en escritura que Utterson consultó afirmó que las dos cartas (la de Jekyll y la supuestamente de Hyde) eran idénticas?", respuesta: false }
                ],
                4: [
                    { texto: "¿La relación entre Jekyll y Lanyon había sido siempre de gran amistad y cercanía?", respuesta: false },
                    { texto: "¿Después del incidente de Carew, Jekyll se volvió más sociable y activo en la vida pública?", respuesta: false },
                    { texto: "¿La salud de Lanyon comenzó a deteriorarse rápidamente después de una conversación con Jekyll?", respuesta: true },
                    { texto: "¿Lanyon se negó a hablar de Jekyll con Utterson, alegando que había tenido un 'shock fatal'?", respuesta: true },
                    { texto: "¿Lanyon le dio a Utterson un sobre sellado con instrucciones de abrirlo solo después de la muerte o desaparición de Jekyll?", respuesta: true },
                    { texto: "¿Utterson leyó el contenido del sobre de Lanyon inmediatamente después de recibirlo?", respuesta: false },
                    { texto: "¿La muerte de Lanyon fue un shock para Utterson, quien lo consideraba un hombre fuerte y saludable?", respuesta: true },
                    { texto: "¿El capítulo sugiere que la 'muerte' de la amistad entre Jekyll y Lanyon fue tan significativa como la muerte física de Lanyon?", respuesta: true },
                    { texto: "¿Utterson, al recibir la carta de Lanyon, sintió una gran curiosidad por saber su contenido, pero se contuvo?", respuesta: true },
                    { texto: "¿La actitud de Lanyon hacia Jekyll se volvió más comprensiva y menos crítica después de su último encuentro?", respuesta: false }
                ],
                5: [
                    { texto: "¿Utterson y Enfield comenzaron a dar sus paseos semanales por el mismo lugar de siempre?", respuesta: false },
                    { texto: "¿Ambos hombres evitaron a toda costa la puerta que los recordaba a Hyde?", respuesta: true },
                    { texto: "¿Enfield sugirió que deberían dejar de hablar de Jekyll y Hyde?", respuesta: true },
                    { texto: "¿El comportamiento de Jekyll en la ventana fue de total tranquilidad y alegría?", respuesta: false },
                    { texto: "¿Utterson y Enfield pudieron ver claramente la transformación de Jekyll en la ventana?", respuesta: false },
                    { texto: "¿La repentina desaparición de Jekyll de la ventana fue percibida como un evento sobrenatural por Utterson?", respuesta: true },
                    { texto: "¿Utterson sintió un 'horror helado' al ver la expresión de Jekyll?", respuesta: true },
                    { texto: "¿Enfield sugirió que deberían visitar a Jekyll después de lo que vieron?", respuesta: false },
                    { texto: "¿El episodio de la ventana solidificó la creencia de Utterson de que algo terrible le estaba ocurriendo a Jekyll?", respuesta: true },
                    { texto: "¿La frase 'Dios nos perdone' dicha por Utterson, indica la gravedad de la situación que presenciaron?", respuesta: true }
                ],
                6: [
                    { texto: "¿Poole estaba preocupado por el doctor Jekyll por la forma en que lo describió y su insistencia en buscar ayuda?", respuesta: true },
                    { texto: "¿La actitud de Poole al describir la voz de la persona en el laboratorio sugiere que creía que Jekyll simplemente estaba enfermo y no era otra persona?", respuesta: false },
                    { texto: "¿El doctor Lanyon recibió una carta certificada de su colega Henry Jekyll el nueve de enero?", respuesta: true },
                    { texto: "¿El doctor Jekyll le pidió a Lanyon que fuera a su casa en taxi para recoger algo de su cuarto de trabajo?", respuesta: true },
                    { texto: "¿Poole le entregó un cajón con varios frascos y papeles al doctor Lanyon?", respuesta: true },
                    { texto: "¿Se puede inferir que el doctor Jekyll le estaba pidiendo a Lanyon que hiciera algo en contra de sus principios éticos al inicio de la carta?", respuesta: true },
                    { texto: "¿La descripción de la transformación que Lanyon presenció es tan vaga que no permite formarse una idea clara de lo que sucedió?", respuesta: false },
                    { texto: "¿El doctor Jekyll nació con una inclinación natural a la laboriosidad y una ambición por la estima de los demás?", respuesta: true },
                    { texto: "¿El doctor Jekyll creía que la separación del bien y el mal en el hombre era una ley fundamental de la vida?", respuesta: true },
                    { texto: "¿Jekyll explica en su confesión que no había experimentado el cambio completo a Hyde antes del incidente de la carta con Lanyon?", respuesta: false },
                    { texto: "¿Se puede inferir que la transformación en Hyde le ofrecía a Jekyll una liberación de las restricciones sociales y morales de su época?", respuesta: true },
                    { texto: "¿El relato de Jekyll sugiere que la dualidad humana, la coexistencia del bien y el mal en una misma persona, es el tema central de la novela?", respuesta: true }
                ]
            },
            "grado8": {
                1: [
                    { texto: "¿La declaración inicial de Juan Pablo Castel de haber matado a María Iribarne busca primordialmente una confesión de culpa y establecer quién narra desde el comienzo?", respuesta: true },
                    { texto: "¿La afirmación de Castel de que los criminales son 'gente más limpia, más inofensiva' implica que él ve su propio acto de asesinato como una acción justificable y superior a las 'bajezas' sociales?", respuesta: true },
                    { texto: "¿La justificación de Castel para escribir su historia, la cual atribuye a la vanidad humana contradice su aparente desinterés por la 'opinión y la justicia de los hombres'?", respuesta: true },
                    { texto: "¿La anécdota de la madre de Castel, donde él sintió 'vanidoso orgullo' al acudir a su lado enferma sirve para eximirlo de toda crítica?", respuesta: false },
                    { texto: "¿La 'débil esperanza' de Castel de que 'alguna persona llegue a entenderme' a pesar de su escepticismo sobre la humanidad, sugiere una profunda necesidad de conexión o validación que contradice su misantropía?", respuesta: true },
                    { texto: "¿La ausencia de la mujer en la inauguración de la exposición, después de su primera aparición, genera en Castel un sentimiento de alivio al saber que su presencia no fue significativa para nadie más?", respuesta: true },
                    { texto: "¿La obsesión de Castel con la mujer que miraba su cuadro sugiere un anhelo de comprensión profunda o una idealización que lo lleva a proyectar sus propias necesidades en ella?", respuesta: true },
                    { texto: "¿La aversión de Castel hacia los grupos, las sectas y los gremios se limita a una mera manía personal, no tiene una justificación crítica?", respuesta: false },
                    { texto: "¿El desprecio de Castel por los críticos de arte se basa en su experiencia personal con ellos, que lo lleva a generalizar sobre su incompetencia?", respuesta: true },
                    { texto: "¿El narrador expresa su frustración por la forma en que los críticos a menudo se equivocan al interpretar el arte, lo que justifica su desdén?", respuesta: true }
                ],
                2: [
                    { texto: "¿La frase 'Bastará decir que soy Juan Pablo Castel, el pintor que mató a María Iribarne' revela de inmediato el desenlace trágico de la historia.", respuesta: true },
                    { texto: "¿La justificación de Castel para escribir su historia, atribuyéndola a la vanidad humana, refuerza su imagen como un individuo modesto y sin pretensiones.", respuesta: false },
                    { texto: "¿Cuando Castel afirma que 'los criminales son gente más limpia', está sugiriendo que sus acciones son moralmente superiores a las 'bajezas' cotidianas de la sociedad.", respuesta: true },
                    { texto: "¿La 'débil esperanza' de Castel de ser comprendido por alguien, a pesar de su escepticismo, indica una contradicción en su misantropía.", respuesta: true },
                    { texto: "¿La ausencia de la mujer en la inauguración de la exposición, después de su primera aparición, calma las ansiedades de Castel, al confirmar que nadie más la notó.", respuesta: false },
                    { texto: "¿La obsesión de Castel con la mujer que miraba su cuadro, sugiere una profunda conexión intelectual que trasciende lo meramente físico.", respuesta: true },
                    { texto: "¿La aversión de Castel hacia los grupos y las sectas es un rasgo menor de su personalidad que no influye en su visión del mundo.", respuesta: false },
                    { texto: "¿El desprecio de Castel por los críticos de arte se basa en su creencia de que solo él posee la verdadera comprensión del arte.", respuesta: true },
                    { texto: "¿La anécdota de Castel y el ciego sirve para ilustrar la facilidad con la que Castel establece conexiones significativas con otras personas.", respuesta: false },
                    { texto: "¿La incapacidad de Castel para mantener un diálogo coherente con el ciego demuestra su profunda soledad y dificultad para la comunicación.", respuesta: true }
                ],
                3: [
                    { texto: "¿El encuentro de Castel con María Iribarne en la playa, donde ella está atenta a sus explicaciones, lo hace sentirse comprendido y esperanzado?", respuesta: true },
                    { texto: "¿Castel describe a María como una persona con una inteligencia y una sensibilidad extraordinarias, que lo atraen profundamente?", respuesta: true },
                    { texto: "¿La decisión de Castel de seguir a María hasta la estancia es un impulso irracional que no tiene ninguna justificación lógica en su mente?", respuesta: false },
                    { texto: "¿El 'odio violento' que Castel experimenta hacia María mientras ella está durmiendo, se explica por una traición anterior de ella hacia él?", respuesta: false },
                    { texto: "¿La confesión de Castel sobre su 'debilidad por las prostitutas' se presenta como una justificación de su inestabilidad emocional?", respuesta: true },
                    { texto: "¿La casa de María, en la que viven otros parientes, representa para Castel un refugio de la soledad y un lugar de pertenencia?", respuesta: false },
                    { texto: "¿La relación entre Castel y el marido de María, Allende, se describe como una de respeto mutuo y entendimiento cordial?", respuesta: false },
                    { texto: "¿Castel percibe las visitas de María a su estudio como un signo inequívoco de su amor y devoción hacia él?", respuesta: false },
                    { texto: "¿El temor de Castel a que María esté 'engañando' lo consume y lo lleva a una espiral de paranoia y celos?", respuesta: true },
                    { texto: "¿La frase 'un túnel oscuro' que describe la visión de Castel sobre el futuro, simboliza su desesperanza y su aislamiento creciente?", respuesta: true }
                ],
                4: [
                    { texto: "¿La confrontación de Castel con Hunter en el estudio de María confirma las sospechas de Castel sobre la infidelidad de María?", respuesta: true },
                    { texto: "¿La 'visita' de María al estudio de Castel, antes de su muerte, se presenta como un intento de reconciliación y de aclarar los malentendidos?", respuesta: false },
                    { texto: "¿Castel interpreta la llegada de María a su estudio en ese momento como una burla final a su obsesión?", respuesta: true },
                    { texto: "¿La acción de María de intentar quemar el cuadro de Castel es una señal de su profundo desprecio por su arte?", respuesta: true },
                    { texto: "¿La descripción del grito de Castel antes del asesinato de María sugiere un momento de lucidez y de arrepentimiento por sus acciones?", respuesta: false },
                    { texto: "¿El hecho de que la luz del dormitorio de María no se encienda después de la de Hunter calma las ansiedades de Castel y le da una sensación de alivio sobre la relación de María con Hunter?", respuesta: false },
                    { texto: "¿El asesinato de María es el resultado de un plan premeditado y lógico de Castel, que culmina sus razonamientos sobre la infidelidad de ella?", respuesta: true },
                    { texto: "¿La confesión de Castel a Allende sobre la infidelidad de María es recibida por el ciego con sorpresa e incredulidad, pero sin una reacción violenta?", respuesta: false },
                    { texto: "¿La frase 'Solo existió un ser que entendía mi pintura', dicha por Castel en el calabozo, se refiere a alguien diferente de María?", respuesta: false },
                    { texto: "¿La 'caverna negra' que se agranda dentro del cuerpo de Castel al final del libro, puede interpretarse como la consumación de su aislamiento, liberándolo de las expectativas de conexión con el mundo exterior?", respuesta: true },
                    { texto: "¿La incapacidad de Castel para razonar sobre la palabra 'insensato' del ciego al final del libro señala una resistencia a la autocrítica que, en su lógica distorsionada, le permite mantener su visión de la realidad sin cuestionar su propia culpabilidad?", respuesta: true },
                    { texto: "¿El hecho de que Castel siga pintando en el encierro significa que ha encontrado una forma de redención o de escapar de su tormento interno?", respuesta: false },
                    { texto: "¿El final del libro implica una resolución clara de los conflictos de Castel y una comprensión de su destino por parte del lectorStamped:false}", respuesta: false },
                    { texto: "¿El tema central del libro, tal como se infiere del fragmento final, es el amor romántico y la búsqueda de la felicidad en una relación de pareja?", respuesta: false }
                ]
            },
            "grado9": {
                1: [
                    { texto: "¿Alexander Coid se despertó al amanecer por una pesadilla?", respuesta: true },
                    { texto: "¿Soñaba Alex que un enorme perro negro se llevaba a su madre?", respuesta: false },
                    { texto: "¿El perro de Alex, Poncho, había sido mordido por un venado?", respuesta: true },
                    { texto: "¿La madre de Alex se afeitó el cabello por gusto?", respuesta: false },
                    { texto: "¿Alex rompió sus pertenencias en la habitación de sus padres?", respuesta: false },
                    { texto: "¿El padre de Alex le dijo que iría al Amazonas solo?", respuesta: true },
                    { texto: "¿Alex estaba emocionado de ir al Amazonas con su abuela Kate?", respuesta: false },
                    { texto: "¿Morgana le robó la cartera a Alex en el bus?", respuesta: true },
                    { texto: "¿Alex creía que el Amazonas estaba lleno de mosquitos y enfermedades?", respuesta: true },
                    { texto: "¿La abuela Kate le enseñó a Alex a fumar para que le dejara de gustar?", respuesta: true }
                ],
                2: [
                    { texto: "¿'Quien boca tiene, a Roma llega' era uno de los axiomas de Kate Coid?", respuesta: true },
                    { texto: "¿Alex era un muchacho tímido y le costaba abordar a desconocidos?", respuesta: true },
                    { texto: "¿Alex consideró que las instrucciones del empleado del restaurante eran fáciles de entender?", respuesta: false },
                    { texto: "¿El hombre que masticaba una hamburguesa le dio a Alex instrucciones claras para llegar a la calle Catorce con la Segunda Avenida?", respuesta: false },
                    { texto: "¿Alex consideró que caminar unas pocas cuadras por terreno plano era más difícil que escalar montañas?", respuesta: false },
                    { texto: "¿El sacerdote afirmó que los indios eran primitivos en lo material pero avanzados en el plano mental?", respuesta: true },
                    { texto: "¿El padre Valdomero vio a la Bestia hace solo unos meses?", respuesta: false },
                    { texto: "¿La Bestia que vio el padre Valdomero medía menos de dos metros?", respuesta: false },
                    { texto: "¿Las huellas que encontró el padre Valdomero eran similares a las de un gorila?", respuesta: true },
                    { texto: "¿El padre Valdomero creía que la Bestia era un animal común y corriente?", respuesta: false }
                ],
                3: [
                    { texto: "¿El profesor Leblanc consideraba a Nadia Santos una alumna excepcional?", respuesta: true },
                    { texto: "¿Nadia Santos había viajado por todo el mundo antes de la expedición?", respuesta: true },
                    { texto: "¿Nadia se preocupaba mucho por las opiniones de los demás?", respuesta: false },
                    { texto: "¿Nadia era capaz de comunicarse con los animales?", respuesta: true },
                    { texto: "¿Nadia y Alex tenían la misma edad?", respuesta: false },
                    { texto: "¿La doctora Omayra Torres se llevaba muy bien con Nadia?", respuesta: false },
                    { texto: "¿Mauro Carías era el director de la expedición al Amazonas?", respuesta: true },
                    { texto: "¿El grupo buscaba una criatura legendaria en el Amazonas?", respuesta: true },
                    { texto: "¿La expedición tenía el apoyo total del gobierno brasileño?", respuesta: false },
                    { texto: "¿Nadia sentía un gran respeto por las tradiciones indígenas?", respuesta: true }
                ],
                4: [
                    { texto: "¿La tribu de los 'Hombres de la Niebla' era conocida por su hospitalidad?", respuesta: false },
                    { texto: "¿El jefe de la tribu, Walimaí, recibió al grupo con alegría?", respuesta: false },
                    { texto: "¿Nadia y Alex fueron los primeros en establecer contacto con la tribu?", respuesta: true },
                    { texto: "¿La tribu vivía en un lugar de difícil acceso, en la cima de un tepuy?", respuesta: true },
                    { texto: "¿Los indígenas ofrecieron comida y refugio al grupo de expedición?", respuesta: false },
                    { texto: "¿Karakawe era un chamán de la tribu que se opuso a la presencia de los 'nahab'?", respuesta: true },
                    { texto: "¿La 'gente invisible' era un mito entre la tribu?", respuesta: false },
                    { texto: "¿El tepuy sagrado era un lugar al que cualquier forastero podía acceder?", respuesta: false },
                    { texto: "¿El grupo de expedición intentó imponer sus costumbres a la tribu?", respuesta: true },
                    { texto: "¿Nadia y Alex se ganaron la confianza de algunos miembros de la tribu?", respuesta: true }
                ],
                5: [
                    { texto: "¿El chamán Karakawe creía que el sarampión podía matar a la tribu si no se vacunaban?", respuesta: true },
                    { texto: "¿Nadia y Alex contaron todo lo que sabían sobre el tepui sagrado a Mauro Carías y los militares?", respuesta: false },
                    { texto: "¿Iyomi aceptó sin discutir que los nahab vacunaran a su gente?", respuesta: false },
                    { texto: "¿Karakawe denunció a Mauro Carías y a la doctora Torres frente al grupo?", respuesta: true },
                    { texto: "¿El capitán Ariosto disparó a Karakawe después de su denuncia?", respuesta: true },
                    { texto: "¿Mauro Carías destruyó las vacunas para evitar que fueran examinadas?", respuesta: true },
                    { texto: "¿La doctora Omayra Torres mostró señales de arrepentimiento por su complicidad en el plan de exterminio?", respuesta: false },
                    { texto: "¿Alexander fue atado a un árbol como castigo por parte de Ariosto?", respuesta: true },
                    { texto: "¿Al final del fragmento la expedición está a salvo y en control de la situación?", respuesta: false },
                    { texto: "¿Nadia logró salir del campamento sin ser vista por los soldados?", respuesta: true },
                    { texto: "¿Walimaí liberó a Alexander de las ataduras con una navaja?", respuesta: true },
                    { texto: "¿La Bestia atacó físicamente al capitán Ariosto con sus garras?", respuesta: true },
                    { texto: "¿Los soldados fueron testigos conscientes del ataque de las BestiasStamped:false}", respuesta: false },
                    { texto: "¿Iyomi dio permiso para que la tribu se vacunara?", respuesta: true },
                    { texto: "¿Los indígenas sabían que los frascos contenían un virus antes de que murieran algunos?", respuesta: false },
                    { texto: "¿La presencia de Nadia ayudó a mejorar la comunicación entre los nahab y los indígenas?", respuesta: true },
                    { texto: "¿Las Bestias fueron utilizadas para castigar tanto a enemigos como a amigos?", respuesta: true }
                ]
            }
        };

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const questionOverlay = document.getElementById("question-overlay");
        const overlayQuestionText = document.getElementById("overlay-question-text");
        const overlayTimerText = document.getElementById("overlay-timer-text");
        const currentQuestionDisplay = document.getElementById("current-question-display");
        const scoreDisplay = document.getElementById("score");
        const levelDisplay = document.getElementById("level");
        const gameOverScreen = document.getElementById("game-over-screen");
        const gameOverTitle = document.getElementById("game-over-title");
        const finalScoreDisplay = document.getElementById("final-score");
        const restartButton = document.getElementById("restart-button");

        // Elementos de la pantalla de inicio
        const startScreen = document.getElementById("start-screen");
        const studentNameInput = document.getElementById("student-name-input");
        const gradeSelection = document.getElementById("grade-selection"); // Nuevo
        const startGameButton = document.getElementById("start-game-button");
        const studentNameDisplay = document.getElementById("student-name-display");

        // Elementos de los controles táctiles
        const upButton = document.getElementById('up-button');
        const downButton = document.getElementById('down-button');
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');

        const box = 20;
        let snake = [];
        let direction = null;
        let food = {}; // Manzana (Verdadero)
        let rat = {}; // Ratón (Falso)
        let score = 0;
        let level = 1;
        let gameSpeed = 200; // Velocidad inicial más lenta (antes 150)
        // let gameInterval; // Usaremos requestAnimationFrame en su lugar, pero mantenemos para claridad (Ya no es necesario)
        let selectedGradeQuestions = {}; // Almacenará las preguntas del grado seleccionado

        let currentLevelQuestions = [];

        let currentQuestion = null;

        let gamePausedForQuestion = true;
        let overlayQuestionTimerInterval; // Para el temporizador de la pregunta en el overlay
        let overlayTimeLeft = 0; // Segundos restantes para el overlay de pregunta
        const OVERLAY_QUESTION_DURATION = 8; // Duración en segundos del overlay de pregunta

        let animationFrameId; // Para requestAnimationFrame
        let lastFrameTime = 0; // Para controlar la velocidad de requestAnimationFrame
        let targetFrameRate; // Se calculará dinámicamente

        const QUESTIONS_TO_LEVEL_UP = 3; // Cuántas preguntas correctas para subir de nivel
        let questionsCorrectInCycle = 0;
        let questionsAnsweredInCycle = 0;

        let initialGameStartListener = null;
        let initialKeyPressHandlerRegistered = false;

        let shouldPresentNewQuestion = false;
        let studentName = "";
        let segmentsToAdd = 0;

        // Cola de movimientos para manejar entradas rápidas
        let moveQueue = [];

        // --- FUNCIONES DE UTILIDAD ---
        function randomPosition() {
            let pos;
            const forbiddenPositions = new Set();
            for (let i = 0; i < snake.length; i++) {
                forbiddenPositions.add(`${snake[i].x},${snake[i].y}`);
            }
            // Asegurarse de que la nueva posición no sea la de la otra comida tampoco
            if (food.x !== undefined) forbiddenPositions.add(`${food.x},${food.y}`);
            if (rat.x !== undefined) forbiddenPositions.add(`${rat.x},${rat.y}`);

            do {
                pos = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box,
                };
            } while (forbiddenPositions.has(`${pos.x},${pos.y}`));
            return pos;
        }

        function collision(head, array, checkAllSegments = false) {
            const startIndex = checkAllSegments ? 0 : 1; // Si checkAllSegments es true, incluye la cabeza
            for (let i = startIndex; i < array.length; i++) {
                if (head.x === array[i].x && head.y === array[i].y) {
                    return true;
                }
            }
            return false;
        }

        // --- INICIALIZACIÓN DEL JUEGO ---
        function initGame() {
            console.log("--- INICIO: Iniciando Juego ---");
            stopAnimationFrameLoop(); // Detener cualquier bucle de animación previo
            clearInterval(overlayQuestionTimerInterval); // Limpiar cualquier temporizador de overlay

            const selectedGrade = gradeSelection.value;
            selectedGradeQuestions = {};
            // Deep copy of questions for the selected grade to allow modification
            for (const lvl in preguntasPorGrado[selectedGrade]) {
                selectedGradeQuestions[lvl] = [...preguntasPorGrado[selectedGrade][lvl]];
            }

            snake = [{ x: 9 * box, y: 10 * box }];
            direction = null; // Reinicia la dirección para que se establezca al primer input
            moveQueue = []; // Limpiar la cola de movimientos
            score = 0;
            level = 1;
            gameSpeed = 200; // Velocidad inicial más lenta (antes 150)
            targetFrameRate = 1000 / (1000 / gameSpeed); // Recalcular targetFrameRate
            questionsCorrectInCycle = 0;
            questionsAnsweredInCycle = 0;
            segmentsToAdd = 0;
            currentQuestion = null;
            food = {};
            rat = {};
            gamePausedForQuestion = true; // Asegurarse de que esté pausado al inicio para mostrar instrucciones
            shouldPresentNewQuestion = false;

            scoreDisplay.innerText = "Puntaje: " + score;
            levelDisplay.innerText = "Nivel: " + level;
            gameOverScreen.style.display = "none";
            currentQuestionDisplay.innerText = "";
            gameOverTitle.innerText = "¡Juego Terminado!";
            finalScoreDisplay.innerText = "";

            studentNameDisplay.innerText = studentName ? `Jugador: ${studentName}` : "";

            startScreen.style.display = "none";
            canvas.style.display = "block";
            currentQuestionDisplay.style.display = "block";


            drawInitialState();

            console.log("INICIO: Mostrando instrucciones iniciales del juego.");
            showInitialInstructions();
            console.log("INICIO: initGame finalizado.");
        }

        function drawInitialState() {
            console.log("DIBUJO: Dibujando estado inicial de la serpiente.");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "lime" : "green";
                ctx.fillRect(snake[i].x, snake[i].y, box, box); // Ojo: Aquí debería ser x, y. Corregido en draw().
            }
        }

        // --- Gestión de la Pantalla de Inicio ---
        function showStartScreen() {
            console.log("ESTADO: Mostrando pantalla de inicio.");
            startScreen.style.display = "flex";
            canvas.style.display = "none";
            questionOverlay.style.display = "none";
            currentQuestionDisplay.style.display = "none";
            gameOverScreen.style.display = "none";
            // Asegurarse de que los controles táctiles estén ocultos aquí inicialmente
            // La media query se encargará de mostrarlos si es una pantalla pequeña
            document.getElementById('touch-controls').style.display = 'none'; // Se oculta por defecto en CSS, pero aseguramos.

            startGameButton.addEventListener('click', startGame);
            studentNameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    startGame();
                }
            });
            studentNameInput.focus();
        }

        function startGame() {
            studentName = studentNameInput.value.trim();
            if (studentName === "") {
                alert("Por favor, introduce tu nombre para empezar.");
                return;
            }
            console.log(`JUGADOR: Nombre del estudiante: ${studentName}, Grado seleccionado: ${gradeSelection.value}`);
            initGame();
        }

        // Función para manejar el inicio del juego desde cualquier input (teclado o táctil)
        function handleGameStartFromInput(inputDirection) {
            // Solo ejecuta si el juego está en pausa por la pantalla de inicio y el listener está activo
            if (gamePausedForQuestion && initialKeyPressHandlerRegistered) {
                console.log(`EVENTO: Input "${inputDirection}" recibido para iniciar juego.`);

                // Desactivar el listener una vez que el juego ha empezado
                document.removeEventListener('keydown', initialGameStartListener);
                // También quitar listeners de botones táctiles para que no activen esta parte del código nuevamente
                upButton.removeEventListener('click', initialTouchStartHandler);
                downButton.removeEventListener('click', initialTouchStartHandler);
                leftButton.removeEventListener('click', initialTouchStartHandler);
                rightButton.removeEventListener('click', initialTouchStartHandler);


                initialKeyPressHandlerRegistered = false; // Marcar que ya se ha iniciado

                direction = inputDirection; // Establecer la dirección inicial
                console.log("DIRECCIÓN: Dirección inicial establecida a:", direction);

                // Ocultar la pantalla de instrucciones con la animación
                questionOverlay.classList.add('slide-out');
                setTimeout(() => {
                    questionOverlay.style.display = "none";
                    console.log("ESTADO: Instrucciones iniciales ocultas. Preparando primera pregunta.");

                    gamePausedForQuestion = false; // El juego NO está pausado para que se mueva la serpiente.
                    loadLevelQuestionsForCurrentLevel(); // Cargar preguntas para el nivel 1
                    presentQuestion(); // Presentar la primera pregunta y colocar la comida

                }, 500); // Esperar a que termine la animación
            }
        }

        // Handler para el inicio del juego con botones táctiles
        const initialTouchStartHandler = (event) => {
            const buttonId = event.currentTarget.id;
            let dir;
            if (buttonId === 'up-button') dir = 'UP';
            else if (buttonId === 'down-button') dir = 'DOWN';
            else if (buttonId === 'left-button') dir = 'LEFT';
            else if (buttonId === 'right-button') dir = 'RIGHT';
            if (dir) handleGameStartFromInput(dir);
        };


        function showInitialInstructions() {
            console.log("ESTADO: Mostrando instrucciones iniciales. Juego pausado.");
            gamePausedForQuestion = true; // Asegurarse de que el juego esté en pausa
            questionOverlay.classList.remove('slide-out'); // Remover clase de animación
            questionOverlay.style.transform = 'translate(-50%, -50%)'; // Resetear posición
            questionOverlay.style.opacity = '1'; // Resetear opacidad

            overlayQuestionText.innerHTML = `
                <h2>¡Hola, ${studentName}!</h2>
                <p>Tu misión es guiar a la serpiente para que coma la respuesta correcta.</p>
                <p>Come el **círculo rojo** si la respuesta es **Verdadero**.</p>
                <p>Come el **cuadrado gris** si es **Falso**.</p>
                <p>Responde ${QUESTIONS_TO_LEVEL_UP} preguntas para subir de nivel. ¡Cuidado, el juego se acelera!</p>
                <p>Evita chocar con las paredes o contigo mismo.</p>
                <p>¡Presiona **cualquier tecla de flecha** o **toca un botón de dirección** para empezar!</p>
            `;
            overlayTimerText.innerText = ""; // Limpiar temporizador

            questionOverlay.style.display = "flex";

            // Registrar el listener solo una vez para el inicio del juego
            if (!initialKeyPressHandlerRegistered) {
                initialGameStartListener = (event) => {
                    if (event.key.startsWith("Arrow")) {
                        handleGameStartFromInput(event.key.replace('Arrow', '').toUpperCase());
                    }
                };
                document.addEventListener('keydown', initialGameStartListener);
                initialKeyPressHandlerRegistered = true;

                // Registrar listeners para botones táctiles para el inicio del juego
                upButton.addEventListener('click', initialTouchStartHandler);
                downButton.addEventListener('click', initialTouchStartHandler);
                leftButton.addEventListener('click', initialTouchStartHandler);
                rightButton.addEventListener('click', initialTouchStartHandler);

                console.log("EVENTO: Listeners para inicio de juego (teclado/táctil) configurados.");
            }
        }

        function loadLevelQuestionsForCurrentLevel() {
            console.log(`PREGUNTAS: Cargando preguntas para Nivel ${level} del grado ${gradeSelection.value}.`);
            // Asegurarse de que se utiliza una copia de las preguntas para que se puedan eliminar
            currentLevelQuestions = selectedGradeQuestions[level] ? [...selectedGradeQuestions[level]] : [];

            if (currentLevelQuestions.length === 0) {
                console.warn(`PREGUNTAS: No hay preguntas para el Nivel ${level} del grado ${gradeSelection.value}.`);
                // Considerar qué hacer si no hay más preguntas para este nivel o grado
                // Por ejemplo, terminar el juego con un mensaje de victoria o avanzar al siguiente grado/nivel
                endGame(true); // Terminar el juego con victoria si se acaban las preguntas
            }
        }


        // --- LÓGICA DE PREGUNTAS Y RESPUESTAS ---
        function presentQuestion() {
            clearInterval(overlayQuestionTimerInterval); // Asegurarse de limpiar cualquier temporizador anterior

            if (currentLevelQuestions.length === 0) {
                console.log("PREGUNTAS: No hay más preguntas disponibles en este nivel. Avanzando de nivel o terminando juego.");
                if (level < Object.keys(selectedGradeQuestions).length) {
                    levelUp();
                    // Después de levelUp, se llamará a presentQuestion de nuevo
                    return;
                } else {
                    endGame(true); // Todas las preguntas de todos los niveles del grado han sido respondidas
                    return;
                }
            }

            const randomIndex = Math.floor(Math.random() * currentLevelQuestions.length);
            currentQuestion = currentLevelQuestions[randomIndex];

            console.log(`PREGUNTAS: Presentando pregunta en overlay: "${currentQuestion.texto}" (Respuesta: ${currentQuestion.respuesta ? 'Verdadero' : 'Falso'})`);

            // Mostrar la pregunta en el overlay grande
            overlayQuestionText.innerText = currentQuestion.texto;
            overlayTimeLeft = OVERLAY_QUESTION_DURATION;
            overlayTimerText.innerText = `Tiempo: ${overlayTimeLeft}s`;
            questionOverlay.classList.remove('slide-out');
            questionOverlay.style.transform = 'translate(-50%, -50%)';
            questionOverlay.style.opacity = '1';
            questionOverlay.style.display = "flex"; // Mostrar el overlay

            // Pausar el juego explícitamente mientras se muestra la pregunta en el overlay
            gamePausedForQuestion = true;
            stopAnimationFrameLoop(); // Detener el movimiento de la serpiente

            // Iniciar el temporizador para el overlay
            overlayQuestionTimerInterval = setInterval(() => {
                overlayTimeLeft--;
                overlayTimerText.innerText = `Tiempo: ${overlayTimeLeft}s`;

                if (overlayTimeLeft <= 0) {
                    clearInterval(overlayQuestionTimerInterval);
                    console.log("PREGUNTAS: Tiempo de overlay de pregunta terminado.");

                    // Ocultar el overlay con animación
                    questionOverlay.classList.add('slide-out');
                    setTimeout(() => {
                        questionOverlay.style.display = "none";
                    }, 500); // Esperar a que la animación termine

                    // Copiar la pregunta al display inferior y reanudar el juego
                    currentQuestionDisplay.innerText = currentQuestion.texto;
                    gamePausedForQuestion = false; // Reanudar el juego
                    startAnimationFrameLoop(); // Iniciar o reanudar el bucle de animación
                }
            }, 1000); // Cada segundo

            placeFoodAndRat(currentQuestion.respuesta);
        }

        function placeFoodAndRat(correctAnswerIsTrue) {
            food = randomPosition(); // Manzana (Verdadero)
            rat = randomPosition(); // Ratón (Falso)

            // Asegurarse de que la manzana y el ratón no se superpongan
            while (food.x === rat.x && food.y === rat.y) {
                rat = randomPosition();
            }

            console.log(`COMIDA: Manzana en (${food.x},${food.y}), Ratón en (${rat.x},${rat.y}).`);
        }

        function checkAnswer(eatenItemIsFood) {
            console.log(`RESPUESTA: Serpiente comió ${eatenItemIsFood ? 'manzana (Verdadero)' : 'ratón (Falso)'}.`);
            const isCorrect = (eatenItemIsFood === currentQuestion.respuesta);

            if (isCorrect) {
                score += 10;
                questionsCorrectInCycle++;
                segmentsToAdd++; // Añadir un segmento por respuesta correcta
                console.log("RESPUESTA: ¡Correcto! Puntaje:", score);
            } else {
                score = Math.max(0, score - 5); // Penalizar si es incorrecto, no bajar de 0
                console.log("RESPUESTA: Incorrecto. Puntaje:", score);
            }
            questionsAnsweredInCycle++;
            scoreDisplay.innerText = "Puntaje: " + score;

            // Eliminar la pregunta ya respondida
            const answeredQuestionIndex = currentLevelQuestions.findIndex(q => q.texto === currentQuestion.texto);
            if (answeredQuestionIndex > -1) {
                currentLevelQuestions.splice(answeredQuestionIndex, 1);
                console.log("PREGUNTAS: Pregunta eliminada. Preguntas restantes en nivel:", currentLevelQuestions.length);
            }

            food = {}; // Quitar la comida del tablero
            rat = {};

            gamePausedForQuestion = true; // Pausar el juego para la siguiente pregunta
            shouldPresentNewQuestion = true;
            checkAndPresentQuestion();
        }

        function checkAndPresentQuestion() {
            if (shouldPresentNewQuestion) {
                shouldPresentNewQuestion = false; // Resetear la bandera
                currentQuestionDisplay.innerText = "Preparando nueva pregunta...";

                setTimeout(() => {
                    if (questionsAnsweredInCycle >= QUESTIONS_TO_LEVEL_UP) {
                        console.log("NIVEL: Intentando subir de nivel...");
                        if (level < Object.keys(selectedGradeQuestions).length) {
                            levelUp();
                        } else {
                            // Si ya está en el último nivel y ha respondido suficientes preguntas
                            endGame(true); // Victoria
                            return;
                        }
                    }
                    // La llamada a presentQuestion ahora maneja la pausa y reanudación del juego
                    presentQuestion(); // Presentar la siguiente pregunta o reiniciar el nivel si no hay más
                }, 1000); // Pequeña pausa antes de la siguiente pregunta
            }
        }

        function levelUp() {
            level++;
            gameSpeed = Math.max(50, gameSpeed - 25); // Acelerar, mínimo 50ms
            targetFrameRate = 1000 / (1000 / gameSpeed); // Recalcular targetFrameRate
            levelDisplay.innerText = "Nivel: " + level;
            questionsCorrectInCycle = 0; // Reiniciar contador para el nuevo nivel
            questionsAnsweredInCycle = 0; // Reiniciar contador para el nuevo nivel
            console.log(`NIVEL: ¡Subiste al Nivel ${level}! Velocidad: ${gameSpeed}ms.`);
            loadLevelQuestionsForCurrentLevel();
            currentQuestionDisplay.innerText = `¡Nivel ${level} alcanzado!`;
            // Esta pregunta se mostrará en el currentQuestionDisplay, y luego la siguiente pregunta se mostrará en el overlay
            setTimeout(() => {
                currentQuestionDisplay.innerText = "";
            }, 1000);
        }

        // --- BUCLE PRINCIPAL DEL JUEGO (requestAnimationFrame) ---
        function gameLoop(currentTime) {
            animationFrameId = requestAnimationFrame(gameLoop);

            // Controla la velocidad del juego. Solo dibuja y actualiza si ha pasado suficiente tiempo.
            const elapsed = currentTime - lastFrameTime;
            if (elapsed < targetFrameRate) {
                return;
            }
            lastFrameTime = currentTime - (elapsed % targetFrameRate); // Ajusta lastFrameTime para una mayor precisión

            if (gamePausedForQuestion) {
                return; // No hacer nada si el juego está pausado
            }

            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar la serpiente
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "lime" : "green";
                ctx.strokeStyle = "darkgreen";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
                ctx.strokeRect(snake[i].x, snake[i].y, box, box);
            }

            // Dibujar la "Manzana" (círculo rojo)
            if (food.x !== undefined) {
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(food.x + box / 2, food.y + box / 2, box / 2 - 2, 0, Math.PI * 2); // Un poco más pequeño
                ctx.fill();
            }

            // Dibujar el "Ratón" (cuadrado gris)
            if (rat.x !== undefined) {
                ctx.fillStyle = "gray";
                ctx.fillRect(rat.x + 2, rat.y + 2, box - 4, box - 4); // Un poco más pequeño
            }

            // Mover la serpiente
            let snakeX = snake[0].x;
            let snakeY = snake[0].y;

            // Procesar el siguiente movimiento en la cola
            if (moveQueue.length > 0) {
                // Eliminar movimientos que resultarían en un giro de 180 grados
                while (moveQueue.length > 0 && direction !== null &&
                       ((moveQueue[0] === 'LEFT' && direction === 'RIGHT') ||
                        (moveQueue[0] === 'RIGHT' && direction === 'LEFT') ||
                        (moveQueue[0] === 'UP' && direction === 'DOWN') ||
                        (moveQueue[0] === 'DOWN' && direction === 'UP'))) {
                    moveQueue.shift(); // Eliminar el movimiento no válido
                }
                if (moveQueue.length > 0) {
                    direction = moveQueue.shift(); // Tomar el primer movimiento válido
                }
            }


            if (direction === "LEFT") snakeX -= box;
            if (direction === "UP") snakeY -= box;
            if (direction === "RIGHT") snakeX += box;
            if (direction === "DOWN") snakeY += box;

            let newHead = { x: snakeX, y: snakeY };

            // Comprobar colisiones
            if (
                snakeX < 0 ||
                snakeX >= canvas.width ||
                snakeY < 0 ||
                snakeY >= canvas.height ||
                collision(newHead, snake)
            ) {
                endGame(false);
                return;
            }

            snake.unshift(newHead); // Añadir nueva cabeza

            // Comprobar si come comida
            let eaten = false;
            if (newHead.x === food.x && newHead.y === food.y) {
                checkAnswer(true); // Ha comido la manzana (Verdadero)
                eaten = true;
            } else if (newHead.x === rat.x && newHead.y === rat.y) {
                checkAnswer(false); // Ha comido el ratón (Falso)
                eaten = true;
            }

            if (!eaten && segmentsToAdd <= 0) {
                snake.pop(); // Eliminar cola si no come y no hay segmentos para añadir
            } else if (segmentsToAdd > 0) {
                segmentsToAdd--; // Reducir los segmentos a añadir
            }
        }


        function setSnakeDirection(eventOrDir) {
            let newDirection;
            if (typeof eventOrDir === 'string') { // Viene de un botón táctil
                newDirection = eventOrDir;
            } else { // Viene de un evento de teclado
                switch (eventOrDir.keyCode) {
                    case 37:
                        newDirection = "LEFT";
                        break;
                    case 38:
                        newDirection = "UP";
                        break;
                    case 39:
                        newDirection = "RIGHT";
                        break;
                    case 40:
                        newDirection = "DOWN";
                        break;
                    default:
                        return; // Ignorar otras teclas
                }
            }

            // Prevenir giro de 180 grados si el juego ya está en movimiento
            if (direction !== null &&
                ((newDirection === "LEFT" && direction === "RIGHT") ||
                 (newDirection === "RIGHT" && direction === "LEFT") ||
                 (newDirection === "UP" && direction === "DOWN") ||
                 (newDirection === "DOWN" && direction === "UP"))) {
                console.log("DIRECCIÓN: Intento de giro de 180 grados ignorado.");
                return;
            }

            // Si el juego aún no ha empezado a moverse (dirección es null), establece la primera dirección
            if (direction === null) {
                direction = newDirection;
                // NOTA: La llamada a startAnimationFrameLoop y presentQuestion
                // ahora se maneja en handleGameStartFromInput.
            } else {
                // Añadir el movimiento a la cola si no es un giro de 180 grados y no es el mismo que el último en cola
                if (moveQueue.length === 0 || moveQueue[moveQueue.length - 1] !== newDirection) {
                    moveQueue.push(newDirection);
                }
            }
        }


        // --- CONTROL DE GAME OVER / VICTORIA ---
        function endGame(isVictory) {
            stopAnimationFrameLoop(); // Detener el bucle del juego
            clearInterval(overlayQuestionTimerInterval); // Detener el temporizador de la pregunta
            gamePausedForQuestion = true; // Asegurarse de que el juego esté en pausa
            gameOverScreen.style.display = "flex"; // Mostrar la pantalla de Game Over
            currentQuestionDisplay.innerText = ""; // Limpiar la pregunta mostrada
            questionOverlay.style.display = "none"; // Ocultar la superposición de pregunta si está visible
            questionOverlay.classList.remove('slide-out'); // Limpiar clases de animación
            questionOverlay.style.transform = 'translate(-50%, -50%)'; // Resetear posición
            questionOverlay.style.opacity = '1'; // Resetear opacidad

            if (isVictory) {
                gameOverTitle.innerText = "¡Felicidades, Juego Completado!"; // Mensaje de victoria
                finalScoreDisplay.innerText = `¡Has respondido todas las preguntas de tu grado!\nPuntaje final: ${score}`;
                console.log("JUEGO: ¡FELICIDADES, HAS COMPLETADO EL JUEGO!");
            } else {
                gameOverTitle.innerText = "¡Juego Terminado!"; // Mensaje de Game Over normal
                finalScoreDisplay.innerText = `Puntaje final: ${score}`;
                console.log("JUEGO: GAME OVER.");
            }
        }

        // --- INICIAR / DETENER BUCLE requestAnimationFrame ---
        function startAnimationFrameLoop() {
            if (!animationFrameId) { // Solo iniciar si no está ya activo
                lastFrameTime = performance.now(); // Reiniciar el tiempo para evitar saltos
                animationFrameId = requestAnimationFrame(gameLoop);
                console.log("ANIMACIÓN: Bucle requestAnimationFrame iniciado.");
            }
        }

        function stopAnimationFrameLoop() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                console.log("ANIMACIÓN: Bucle requestAnimationFrame detenido.");
            }
        }

        // --- EVENTO DE REINICIO ---\
        restartButton.addEventListener("click", initGame);

        // --- MANEJADORES DE EVENTOS DE TECLADO Y TÁCTILES ---
        document.addEventListener("keydown", setSnakeDirection);

        upButton.addEventListener('click', () => setSnakeDirection('UP'), { passive: true });
        downButton.addEventListener('click', () => setSnakeDirection('DOWN'), { passive: true });
        leftButton.addEventListener('click', () => setSnakeDirection('LEFT'), { passive: true });
        rightButton.addEventListener('click', () => setSnakeDirection('RIGHT'), { passive: true });

        console.log("EVENTOS: Listeners de teclado y táctiles para dirección de serpiente configurados.");


        // --- INICIAR LA PANTALLA DE INICIO AL CARGAR LA PÁGINA ---\
        window.onload = showStartScreen;

    </script>
</body>
</html>
