<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Serpiente Sabia 2D</title>
    <style>
        body {
            color: white;
            font-family: 'Press Start 2P', cursive; /* Fuente pixelada para estilo retro */
            text-align: center;
            background-color: #1a1a1a; /* Fondo oscuro */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Alinea los elementos al inicio (arriba) */
            min-height: 100vh; /* Ocupa el 100% de la altura de la ventana */
            margin: 0;
            overflow: hidden; /* Ocultamos el scroll */
            padding: 5px 0; /* Pequeño padding para que el contenido no toque los bordes */
            box-sizing: border-box; /* Incluir padding en la altura total */
        }
        h1 {
            color: #00ff00; /* Verde neón para el título */
            font-size: 1.6em; /* Un poco más pequeño */
            margin-top: 5px; /* Margen superior muy reducido */
            margin-bottom: 5px;
        }
        canvas {
            background: #000;
            border: 2px solid #00ff00; /* Borde verde neón */
            display: block;
            margin: 5px auto; /* Margen vertical muy reducido */
        }
        #game-header { /* Contenedor superior para instrucciones, puntaje y nivel */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 400px; /* Ancho del canvas */
            margin-bottom: 5px;
        }
        #instructions {
            font-size: 0.7em; /* Aún más pequeño para instrucciones */
            margin-bottom: 3px; /* Reducir aún más el margen inferior */
            color: #ccc;
        }
        #score-level-bar {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Alinea verticalmente los elementos */
            width: 100%;
            font-size: 0.9em; /* Más pequeño para puntaje/nivel */
            color: #fff;
            margin-top: 0px;
            padding: 0 5px;
            box-sizing: border-box;
        }
        #score, #level, #student-name-display { /* Ajustar para el nuevo display de nombre */
            margin: 0;
        }
        #student-name-display {
            color: #ffcc00; /* Color distintivo para el nombre */
        }

        /* --- Estilos para la Pantalla de Inicio --- */
        #start-screen {
            background-color: rgba(0, 0, 0, 0.95);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; /* Para que esté por encima de todo */
            color: #00ff00;
            font-size: 1.2em;
        }
        #start-screen h2 {
            color: #00ff00;
            margin-bottom: 20px;
        }
        #start-screen p {
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        #start-screen input, #start-screen select {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #00ff00;
            background-color: #333;
            color: white;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            max-width: 250px;
        }
        #start-screen button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: 'Press Start 2P', cursive;
        }
        #start-screen button:hover {
            background-color: #00cc00;
        }

        /* --- Estilos para Botones Táctiles --- */
        #touch-controls {
            display: none; /* Oculto por defecto, se muestra con media query */
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
            user-select: none; /* Prevenir selección de texto al tocar */
            -webkit-user-select: none; /* Para iOS */
            -ms-user-select: none; /* Para IE/Edge */
            -moz-user-select: none; /* Para Firefox */
            touch-action: manipulation; /* Evitar comportamientos del navegador como el zoom con doble toque */
        }

        .dpad-button {
            background-color: #004d00; /* Verde oscuro */
            color: #00ff00; /* Texto verde neón */
            border: 2px solid #00ff00;
            font-size: 2em; /* Iconos grandes */
            width: 60px; /* Botones cuadrados */
            height: 60px;
            margin: 5px; /* Espacio entre botones */
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            font-family: sans-serif; /* Usar una fuente estándar para los símbolos */
        }

        .dpad-button:active { /* Feedback al tocar */
            background-color: #00ff00;
            color: #000;
            transform: scale(0.95);
        }

        #touch-controls .horizontal-buttons {
            display: flex;
        }

        /* Media Query para mostrar botones táctiles en pantallas pequeñas */
        @media (max-width: 768px) { /* Este breakpoint se puede ajustar */
            #touch-controls {
                display: flex; /* Mostrar botones en pantallas pequeñas */
            }
            #instructions {
                font-size: 0.6em; /* Hacer las instrucciones más pequeñas para ahorrar espacio */
            }
        }


        #question-overlay { /* Caja para la pregunta central y temporizador */
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 10px; /* Reducir padding */
            max-width: 70%;
            display: none; /* Inicialmente oculto */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            min-height: 100px; /* Asegurar un tamaño mínimo */
            box-sizing: border-box;
        }
        #question-overlay.slide-out {
            transform: translate(-50%, 150%);
            opacity: 0;
        }
        #overlay-question-text {
            font-size: 1em; /* Ajustar tamaño de la pregunta central */
            margin-bottom: 8px; /* Reducir margen */
            color: #fff;
        }
        #overlay-timer-text {
            font-size: 0.8em; /* Más pequeño para el temporizador */
            color: #ffcc00;
        }
        #game-over-screen {
            background-color: rgba(0, 0, 0, 0.9);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            display: none;
        }
        #game-over-screen h2 {
            color: #ff0000;
            font-size: 2.2em; /* Reducir tamaño de "Juego Terminado" */
            margin-bottom: 10px;
        }
        #game-over-screen p {
            font-size: 1.1em; /* Reducir tamaño de texto en game over */
            margin-bottom: 15px;
        }
        #restart-button {
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 8px 15px; /* Reducir padding del botón */
            font-size: 0.9em; /* Reducir tamaño de fuente del botón */
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #restart-button:hover {
            background-color: #00cc00;
        }
        /* Estilo para la pregunta que aparece debajo del juego */
        #current-question-display {
            font-size: 0.9em; /* Más pequeño para la pregunta de abajo */
            color: #00ff00;
            margin-top: 8px; /* Reducir margen superior */
            min-height: 2em; /* Mantener para evitar saltos si el texto es corto */
            max-width: 90%;
            text-align: center;
            padding: 0 5px;
            box-sizing: border-box;
            display: none; /* Inicialmente oculto */
        }

        /* Importar fuente de Google Fonts para estilo retro */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    </style>
</head>
<body>
    <h1>Serpiente Sabia 2D</h1>

    <div id="start-screen">
        <h2>Bienvenido a Serpiente Sabia</h2>
        <p>Ingresa tu nombre para comenzar:</p>
        <input type="text" id="student-name-input" placeholder="Tu nombre" maxlength="20">
        <p>Selecciona tu grado:</p>
        <select id="grade-selection">
            <option value="grado7">Grado 7</option>
            <option value="grado8">Grado 8</option>
            <option value="grado9">Grado 9</option>
        </select>
        <button id="start-game-button">¡Empezar a Jugar!</button>
    </div>

    <div id="game-header">
        <p id="instructions">Come la **manzana** si la respuesta es **Verdadero**, o el **ratón** si es **Falso**.</p>
        <div id="score-level-bar">
            <p id="student-name-display"></p> <p id="score">Puntaje: 0</p>
            <p id="level">Nivel: 1</p>
        </div>
    </div>

    <canvas id="game" width="400" height="400"></canvas>

    <div id="touch-controls">
        <button id="up-button" class="dpad-button">⬆️</button>
        <div class="horizontal-buttons">
            <button id="left-button" class="dpad-button">⬅️</button>
            <button id="right-button" class="dpad-button">➡️</button>
        </div>
        <button id="down-button" class="dpad-button">⬇️</button>
    </div>

    <div id="question-overlay">
        <p id="overlay-question-text"></p>
        <p id="overlay-timer-text"></p> </div>

    <p id="current-question-display"></p>

    <div id="game-over-screen">
        <h2 id="game-over-title">¡Juego Terminado!</h2>
        <p id="final-score">Puntaje final: 0</p>
        <button id="restart-button">Jugar de Nuevo</button>
    </div>

    <script>
        // --- PREGUNTAS POR GRADO Y NIVEL ---
        const preguntasPorGrado = {
            "grado7": {
                1: [
                    { texto: "¿La descripción inicial del notario Utterson sugiere que es un hombre extrovertido y de emociones fácilmente expresables?", respuesta: false },
                    { texto: "¿La historia que cuenta Enfield sobre la puerta y el incidente con la niña implica que el personaje de Hyde es percibido como inofensivo por quienes lo encuentran?", respuesta: false },
                    { texto: "¿La descripción de la casa conectada a la puerta, con su aspecto cuidado, contrasta directamente con la apariencia deteriorada de la puerta en sí misma?", respuesta: true },
                    { texto: "¿La incapacidad de Enfield para describir concretamente a Hyde, más allá de una 'fuerte sensación de deformidad', indica que su recuerdo del hombre es vago e impreciso?", respuesta: false },
                    { texto: "¿El pacto final propuesto por Enfield al final del capítulo implica que ambos hombres han decidido ignorar por completo el misterio que rodea a Hyde?", respuesta: true },
                    { texto: "¿El desagrado que Utterson sentía por Hyde era tan profunda que no podía explicarse solo por los rasgos físicos negativos que observó en él?", respuesta: true },
                    { texto: "¿Antes de que Utterson le preguntara, Lanyon ya había escuchado el nombre de Hyde?", respuesta: false },
                    { texto: "¿En sus sueños, Utterson sentía una curiosidad muy fuerte e irresistible por conocer el rostro de Hyde?", respuesta: true },
                    { texto: "¿El testamento de Jekyll establecía que Hyde tomaría posesión de sus bienes si el doctor desaparecía por un periodo superior a tres meses?", respuesta: true },
                    { texto: "¿Utterson consideró que no tenía ninguna culpa en su pasado al analizarlo?", respuesta: false }
                ],
                2: [
                    { texto: "¿El doctor Jekyll y Utterson eran viejos compañeros, como se indica en el texto?", respuesta: true },
                    { texto: "¿Al inicio de la conversación, el doctor Jekyll mostró muchas ganas de hablar sobre el tema de Hyde?", respuesta: false },
                    { texto: "¿Jekyll afirmó que él podía librarse de Hyde en cualquier momento que quisiera?", respuesta: true },
                    { texto: "¿Jekyll insistió en que Utterson debía dejar de investigar a Hyde?", respuesta: true },
                    { texto: "¿Jekyll parecía completamente tranquilo y en paz al hablar de Hyde?", respuesta: false },
                    { texto: "¿Utterson se llevó un gran alivio después de hablar con Jekyll sobre Hyde?", respuesta: false },
                    { texto: "¿La descripción del comportamiento de Jekyll al inicio del capítulo implica que estaba actuando de manera normal y despreocupada?", respuesta: false },
                    { texto: "¿Se puede inferir que Utterson sospechaba que Jekyll estaba ocultando algo, incluso después de su conversación?", respuesta: true },
                    { texto: "¿La reacción de Jekyll ante las preguntas de Utterson fue de total cooperación y transparencia?", respuesta: false },
                    { texto: "¿La frase '¡Esto es una cuestión de mi vida o de mi muerte!' indica la extrema importancia de la relación de Jekyll con Hyde?", respuesta: true }
                ],
                3: [
                    { texto: "¿La sirvienta que presenció el asesinato de Sir Danvers Carew estaba dormida en el momento del crimen?", respuesta: false },
                    { texto: "¿El asesinato de Carew ocurrió al atardecer, bajo una luna llena?", respuesta: false },
                    { texto: "¿La sirvienta describió al asesino como un hombre de baja estatura y aspecto despreciable?", respuesta: true },
                    { texto: "¿El arma utilizada en el asesinato fue una pistola?", respuesta: false },
                    { texto: "¿Utterson reconoció el arma como el bastón que le había regalado a Jekyll?", respuesta: true },
                    { texto: "¿El doctor Jekyll parecía profundamente afectado por la noticia del asesinato de Carew?", respuesta: true },
                    { texto: "¿Jekyll le entregó una carta a Utterson, afirmando que había sido escrita por Hyde?", respuesta: true },
                    { texto: "¿Utterson creyó la historia de Jekyll sobre la carta sin ninguna duda?", respuesta: false },
                    { texto: "¿Poole le confirmó a Utterson que ningún mensajero había traído la carta a la casa de Jekyll?", respuesta: true },
                    { texto: "¿El experto en escritura que Utterson consultó afirmó que las dos cartas (la de Jekyll y la supuestamente de Hyde) eran idénticas?", respuesta: false }
                ],
                4: [
                    { texto: "¿La relación entre Jekyll y Lanyon había sido siempre de gran amistad y cercanía?", respuesta: false },
                    { texto: "¿Después del incidente de Carew, Jekyll se volvió más sociable y activo en la vida pública?", respuesta: false },
                    { texto: "¿La salud de Lanyon comenzó a deteriorarse rápidamente después de una conversación con Jekyll?", respuesta: true },
                    { texto: "¿Lanyon se negó a hablar de Jekyll con Utterson, alegando que había tenido un 'shock fatal'?", respuesta: true },
                    { texto: "¿Lanyon le dio a Utterson un sobre sellado con instrucciones de abrirlo solo después de la muerte o desaparición de Jekyll?", respuesta: true },
                    { texto: "¿Utterson leyó el contenido del sobre de Lanyon inmediatamente después de recibirlo?", respuesta: false },
                    { texto: "¿La muerte de Lanyon fue un shock para Utterson, quien lo consideraba un hombre fuerte y saludable?", respuesta: true },
                    { texto: "¿El capítulo sugiere que la 'muerte' de la amistad entre Jekyll y Lanyon fue tan significativa como la muerte física de Lanyon?", respuesta: true },
                    { texto: "¿Utterson, al recibir la carta de Lanyon, sintió una gran curiosidad por saber su contenido, pero se contuvo?", respuesta: true },
                    { texto: "¿La actitud de Lanyon hacia Jekyll se volvió más comprensiva y menos crítica después de su último encuentro?", respuesta: false }
                ],
                5: [
                    { texto: "¿Utterson y Enfield comenzaron a dar sus paseos semanales por el mismo lugar de siempre?", respuesta: false },
                    { texto: "¿Ambos hombres evitaron a toda costa la puerta que los recordaba a Hyde?", respuesta: true },
                    { texto: "¿Enfield sugirió que deberían dejar de hablar de Jekyll y Hyde?", respuesta: true },
                    { texto: "¿El comportamiento de Jekyll en la ventana fue de total tranquilidad y alegría?", respuesta: false },
                    { texto: "¿Utterson y Enfield pudieron ver claramente la transformación de Jekyll en la ventana?", respuesta: false },
                    { texto: "¿La repentina desaparición de Jekyll de la ventana fue percibida como un evento sobrenatural por Utterson?", respuesta: true },
                    { texto: "¿Utterson sintió un 'horror helado' al ver la expresión de Jekyll?", respuesta: true },
                    { texto: "¿Enfield sugirió que deberían visitar a Jekyll después de lo que vieron?", respuesta: false },
                    { texto: "¿El episodio de la ventana solidificó la creencia de Utterson de que algo terrible le estaba ocurriendo a Jekyll?", respuesta: true },
                    { texto: "¿La frase 'Dios nos perdone' dicha por Utterson, indica la gravedad de la situación que presenciaron?", respuesta: true }
                ],
                6: [
                    { texto: "¿Poole estaba preocupado por el doctor Jekyll por la forma en que lo describió y su insistencia en buscar ayuda?", respuesta: true },
                    { texto: "¿La actitud de Poole al describir la voz de la persona en el laboratorio sugiere que creía que Jekyll simplemente estaba enfermo y no era otra persona?", respuesta: false },
                    { texto: "¿El doctor Lanyon recibió una carta certificada de su colega Henry Jekyll el nueve de enero?", respuesta: true },
                    { texto: "¿El doctor Jekyll le pidió a Lanyon que fuera a su casa en taxi para recoger algo de su cuarto de trabajo?", respuesta: true },
                    { texto: "¿Poole le entregó un cajón con varios frascos y papeles al doctor Lanyon?", respuesta: true },
                    { texto: "¿Se puede inferir que el doctor Jekyll le estaba pidiendo a Lanyon que hiciera algo en contra de sus principios éticos al inicio de la carta?", respuesta: true },
                    { texto: "¿La descripción de la transformación que Lanyon presenció es tan vaga que no permite formarse una idea clara de lo que sucedió?", respuesta: false },
                    { texto: "¿El doctor Jekyll nació con una inclinación natural a la laboriosidad y una ambición por la estima de los demás?", respuesta: true },
                    { texto: "¿El doctor Jekyll creía que la separación del bien y el mal en el hombre era una ley fundamental de la vida?", respuesta: true },
                    { texto: "¿Jekyll explica en su confesión que no había experimentado el cambio completo a Hyde antes del incidente de la carta con Lanyon?", respuesta: false },
                    { texto: "¿Se puede inferir que la transformación en Hyde le ofrecía a Jekyll una liberación de las restricciones sociales y morales de su época?", respuesta: true },
                    { texto: "¿El relato de Jekyll sugiere que la dualidad humana, la coexistencia del bien y el mal en una misma persona, es el tema central de la novela?", respuesta: true }
                ]
            },
            "grado8": {
                1: [
                    { texto: "¿La declaración inicial de Juan Pablo Castel de haber matado a María Iribarne busca primordialmente una confesión de culpa y establecer quién narra desde el comienzo?", respuesta: true },
                    { texto: "¿La afirmación de Castel de que los criminales son 'gente más limpia, más inofensiva' implica que él ve su propio acto de asesinato como una acción justificable y superior a las 'bajezas' sociales?", respuesta: true },
                    { texto: "¿La justificación de Castel para escribir su historia, la cual atribuye a la vanidad humana contradice su aparente desinterés por la 'opinión y la justicia de los hombres'?", respuesta: true },
                    { texto: "¿La anécdota de la madre de Castel, donde él sintió 'vanidoso orgullo' al acudir a su lado enferma sirve para eximirlo de toda crítica?", respuesta: false },
                    { texto: "¿La 'débil esperanza' de Castel de que 'alguna persona llegue a entenderme' a pesar de su escepticismo sobre la humanidad, sugiere una profunda necesidad de conexión o validación que contradice su misantropía?", respuesta: true },
                    { texto: "¿La ausencia de la mujer en la inauguración de la exposición, después de su primera aparición, genera en Castel un sentimiento de alivio al saber que su presencia no fue significativa para nadie más?", respuesta: true },
                    { texto: "¿La obsesión de Castel con la mujer que miraba su cuadro sugiere un anhelo de comprensión profunda o una idealización que lo lleva a proyectar sus propias necesidades en ella?", respuesta: true },
                    { texto: "¿La aversión de Castel hacia los grupos, las sectas y los gremios se limita a una mera manía personal, no tiene una justificación crítica?", respuesta: false },
                    { texto: "¿El desprecio de Castel por los críticos de arte se basa en su experiencia personal con ellos, que lo lleva a generalizar sobre su incompetencia?", respuesta: true },
                    { texto: "¿El narrador expresa su frustración por la forma en que los críticos a menudo se equivocan al interpretar el arte, lo que justifica su desdén?", respuesta: true }
                ],
                2: [
                    { texto: "¿La frase 'Bastará decir que soy Juan Pablo Castel, el pintor que mató a María Iribarne' revela de inmediato el desenlace trágico de la historia.", respuesta: true },
                    { texto: "¿La justificación de Castel para escribir su historia, atribuyéndola a la vanidad humana, refuerza su imagen como un individuo modesto y sin pretensiones.", respuesta: false },
                    { texto: "¿Cuando Castel afirma que 'los criminales son gente más limpia', está sugiriendo que sus acciones son moralmente superiores a las 'bajezas' cotidianas de la sociedad.", respuesta: true },
                    { texto: "¿La 'débil esperanza' de Castel de ser comprendido por alguien, a pesar de su escepticismo, indica una contradicción en su misantropía.", respuesta: true },
                    { texto: "¿La ausencia de la mujer en la inauguración de la exposición, después de su primera aparición, calma las ansiedades de Castel, al confirmar que nadie más la notó.", respuesta: false },
                    { texto: "¿La obsesión de Castel con la mujer que miraba su cuadro, sugiere una profunda conexión intelectual que trasciende lo meramente físico.", respuesta: true },
                    { texto: "¿La aversión de Castel hacia los grupos y las sectas es un rasgo menor de su personalidad que no influye en su visión del mundo.", respuesta: false },
                    { texto: "¿El desprecio de Castel por los críticos de arte se basa en su creencia de que solo él posee la verdadera comprensión del arte.", respuesta: true },
                    { texto: "¿La anécdota de Castel y el ciego sirve para ilustrar la facilidad con la que Castel establece conexiones significativas con otras personas.", respuesta: false },
                    { texto: "¿La incapacidad de Castel para mantener un diálogo coherente con el ciego demuestra su profunda soledad y dificultad para la comunicación.", respuesta: true }
                ],
                3: [
                    { texto: "¿El encuentro de Castel con María Iribarne en la playa, donde ella está atenta a sus explicaciones, lo hace sentirse comprendido y esperanzado?", respuesta: true },
                    { texto: "¿Castel describe a María como una persona con una inteligencia y una sensibilidad extraordinarias, que lo atraen profundamente?", respuesta: true },
                    { texto: "¿La decisión de Castel de seguir a María hasta la estancia es un impulso irracional que no tiene ninguna justificación lógica en su mente?", respuesta: false },
                    { texto: "¿El 'odio violento' que Castel experimenta hacia María mientras ella está durmiendo, se explica por una traición anterior de ella hacia él?", respuesta: false },
                    { texto: "¿La confesión de Castel sobre su 'debilidad por las prostitutas' se presenta como una justificación de su inestabilidad emocional?", respuesta: true },
                    { texto: "¿La casa de María, en la que viven otros parientes, representa para Castel un refugio de la soledad y un lugar de pertenencia?", respuesta: false },
                    { texto: "¿La relación entre Castel y el marido de María, Allende, se describe como una de respeto mutuo y entendimiento cordial?", respuesta: false },
                    { texto: "¿Castel percibe las visitas de María a su estudio como un signo inequívoco de su amor y devoción hacia él?", respuesta: false },
                    { texto: "¿El temor de Castel a que María esté 'engañando' lo consume y lo lleva a una espiral de paranoia y celos?", respuesta: true },
                    { texto: "¿La frase 'un túnel oscuro' que describe la visión de Castel sobre el futuro, simboliza su desesperanza y su aislamiento creciente?", respuesta: true }
                ],
                4: [
                    { texto: "¿La confrontación de Castel con Hunter en el estudio de María confirma las sospechas de Castel sobre la infidelidad de María?", respuesta: true },
                    { texto: "¿La 'visita' de María al estudio de Castel, antes de su muerte, se presenta como un intento de reconciliación y de aclarar los malentendidos?", respuesta: false },
                    { texto: "¿Castel interpreta la llegada de María a su estudio en ese momento como una burla final a su obsesión?", respuesta: true },
                    { texto: "¿La acción de María de intentar quemar el cuadro de Castel es una señal de su profundo desprecio por su arte?", respuesta: true },
                    { texto: "¿La descripción del grito de Castel antes del asesinato de María sugiere un momento de lucidez y de arrepentimiento por sus acciones?", respuesta: false },
                    { texto: "¿El hecho de que la luz del dormitorio de María no se encienda después de la de Hunter calma las ansiedades de Castel y le da una sensación de alivio sobre la relación de María con Hunter?", respuesta: false },
                    { texto: "¿El asesinato de María es el resultado de un plan premeditado y lógico de Castel, que culmina sus razonamientos sobre la infidelidad de ella?", respuesta: true },
                    { texto: "¿La confesión de Castel a Allende sobre la infidelidad de María es recibida por el ciego con sorpresa e incredulidad, pero sin una reacción violenta?", respuesta: false },
                    { texto: "¿La frase 'Solo existió un ser que entendía mi pintura', dicha por Castel en el calabozo, se refiere a alguien diferente de María?", respuesta: false },
                    { texto: "¿La 'caverna negra' que se agranda dentro del cuerpo de Castel al final del libro, puede interpretarse como la consumación de su aislamiento, liberándolo de las expectativas de conexión con el mundo exterior?", respuesta: true },
                    { texto: "¿La incapacidad de Castel para razonar sobre la palabra 'insensato' del ciego al final del libro señala una resistencia a la autocrítica que, en su lógica distorsionada, le permite mantener su visión de la realidad sin cuestionar su propia culpabilidad?", respuesta: true },
                    { texto: "¿El hecho de que Castel siga pintando en el encierro significa que ha encontrado una forma de redención o de escapar de su tormento interno?", respuesta: false },
                    { texto: "¿El final del libro implica una resolución clara de los conflictos de Castel y una comprensión de su destino por parte del lector?", respuesta: false },
                    { texto: "¿El tema central del libro, tal como se infiere del fragmento final, es el amor romántico y la búsqueda de la felicidad en una relación de pareja?", respuesta: false }
                ]
            },
            "grado9": {
                1: [
                    { texto: "¿Alexander Coid se despertó al amanecer por una pesadilla?", respuesta: true },
                    { texto: "¿Soñaba Alex que un enorme perro negro se llevaba a su madre?", respuesta: false },
                    { texto: "¿El perro de Alex, Poncho, había sido mordido por un venado?", respuesta: true },
                    { texto: "¿La madre de Alex se afeitó el cabello por gusto?", respuesta: false },
                    { texto: "¿Alex rompió sus pertenencias en la habitación de sus padres?", respuesta: false },
                    { texto: "¿El padre de Alex le dijo que iría al Amazonas solo?", respuesta: true },
                    { texto: "¿Alex estaba emocionado de ir al Amazonas con su abuela Kate?", respuesta: false },
                    { texto: "¿Morgana le robó la cartera a Alex en el bus?", respuesta: true },
                    { texto: "¿Alex creía que el Amazonas estaba lleno de mosquitos y enfermedades?", respuesta: true },
                    { texto: "¿La abuela Kate le enseñó a Alex a fumar para que le dejara de gustar?", respuesta: true }
                ],
                2: [
                    { texto: "¿'Quien boca tiene, a Roma llega' era uno de los axiomas de Kate Coid?", respuesta: true },
                    { texto: "¿Alex era un muchacho tímido y le costaba abordar a desconocidos?", respuesta: true },
                    { texto: "¿Alex consideró que las instrucciones del empleado del restaurante eran fáciles de entender?", respuesta: false },
                    { texto: "¿El hombre que masticaba una hamburguesa le dio a Alex instrucciones claras para llegar a la calle Catorce con la Segunda Avenida?", respuesta: false },
                    { texto: "¿Alex consideró que caminar unas pocas cuadras por terreno plano era más difícil que escalar montañas?", respuesta: false },
                    { texto: "¿El sacerdote afirmó que los indios eran primitivos en lo material pero avanzados en el plano mental?", respuesta: true },
                    { texto: "¿El padre Valdomero vio a la Bestia hace solo unos meses?", respuesta: false },
                    { texto: "¿La Bestia que vio el padre Valdomero medía menos de dos metros?", respuesta: false },
                    { texto: "¿Las huellas que encontró el padre Valdomero eran similares a las de un gorila?", respuesta: true },
                    { texto: "¿El padre Valdomero creía que la Bestia era un animal común y corriente?", respuesta: false }
                ],
                3: [
                    { texto: "¿El profesor Leblanc consideraba a Nadia Santos una alumna excepcional?", respuesta: true },
                    { texto: "¿Nadia Santos había viajado por todo el mundo antes de la expedición?", respuesta: true },
                    { texto: "¿Nadia se preocupaba mucho por las opiniones de los demás?", respuesta: false },
                    { texto: "¿Nadia era capaz de comunicarse con los animales?", respuesta: true },
                    { texto: "¿Nadia y Alex tenían la misma edad?", respuesta: false },
                    { texto: "¿La doctora Omayra Torres se llevaba muy bien con Nadia?", respuesta: false },
                    { texto: "¿Mauro Carías era el director de la expedición al Amazonas?", respuesta: true },
                    { texto: "¿El grupo buscaba una criatura legendaria en el Amazonas?", respuesta: true },
                    { texto: "¿La expedición tenía el apoyo total del gobierno brasileño?", respuesta: false },
                    { texto: "¿Nadia sentía un gran respeto por las tradiciones indígenas?", respuesta: true }
                ],
                4: [
                    { texto: "¿La tribu de los 'Hombres de la Niebla' era conocida por su hospitalidad?", respuesta: false },
                    { texto: "¿El jefe de la tribu, Walimaí, recibió al grupo con alegría?", respuesta: false },
                    { texto: "¿Nadia y Alex fueron los primeros en establecer contacto con la tribu?", respuesta: true },
                    { texto: "¿La tribu vivía en un lugar de difícil acceso, en la cima de un tepuy?", respuesta: true },
                    { texto: "¿Los indígenas ofrecieron comida y refugio al grupo de expedición?", respuesta: false },
                    { texto: "¿Karakawe era un chamán de la tribu que se opuso a la presencia de los 'nahab'?", respuesta: true },
                    { texto: "¿La 'gente invisible' era un mito entre la tribu?", respuesta: false },
                    { texto: "¿El tepuy sagrado era un lugar al que cualquier forastero podía acceder?", respuesta: false },
                    { texto: "¿El grupo de expedición intentó imponer sus costumbres a la tribu?", respuesta: true },
                    { texto: "¿Nadia y Alex se ganaron la confianza de algunos miembros de la tribu?", respuesta: true }
                ],
                5: [
                    { texto: "¿El chamán Karakawe creía que el sarampión podía matar a la tribu si no se vacunaban?", respuesta: true },
                    { texto: "¿Nadia y Alex contaron todo lo que sabían sobre el tepui sagrado a Mauro Carías y los militares?", respuesta: false },
                    { texto: "¿Iyomi aceptó sin discutir que los nahab vacunaran a su gente?", respuesta: false },
                    { texto: "¿Karakawe denunció a Mauro Carías y a la doctora Torres frente al grupo?", respuesta: true },
                    { texto: "¿El capitán Ariosto disparó a Karakawe después de su denuncia?", respuesta: true },
                    { texto: "¿Mauro Carías destruyó las vacunas para evitar que fueran examinadas?", respuesta: true },
                    { texto: "¿La doctora Omayra Torres mostró señales de arrepentimiento por su complicidad en el plan de exterminio?", respuesta: false },
                    { texto: "¿Alexander fue atado a un árbol como castigo por parte de Ariosto?", respuesta: true },
                    { texto: "¿Al final del fragmento la expedición está a salvo y en control de la situación?", respuesta: false },
                    { texto: "¿Nadia logró salir del campamento sin ser vista por los soldados?", respuesta: true },
                    { texto: "¿Walimaí liberó a Alexander de las ataduras con una navaja?", respuesta: true },
                    { texto: "¿La Bestia atacó físicamente al capitán Ariosto con sus garras?", respuesta: true },
                    { texto: "¿Los soldados fueron testigos conscientes del ataque de las Bestias?", respuesta: false },
                    { texto: "¿Iyomi dio permiso para que la tribu se vacunara?", respuesta: true },
                    { texto: "¿Los indígenas sabían que los frascos contenían un virus antes de que murieran algunos?", respuesta: false },
                    { texto: "¿La presencia de Nadia ayudó a mejorar la comunicación entre los nahab y los indígenas?", respuesta: true },
                    { texto: "¿Las Bestias fueron utilizadas para castigar tanto a enemigos como a amigos?", respuesta: true }
                ]
            }
        };

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const questionOverlay = document.getElementById("question-overlay");
        const overlayQuestionText = document.getElementById("overlay-question-text");
        const overlayTimerText = document.getElementById("overlay-timer-text");
        const currentQuestionDisplay = document.getElementById("current-question-display");
        const scoreDisplay = document.getElementById("score");
        const levelDisplay = document.getElementById("level");
        const gameOverScreen = document.getElementById("game-over-screen");
        const gameOverTitle = document.getElementById("game-over-title");
        const finalScoreDisplay = document.getElementById("final-score");
        const restartButton = document.getElementById("restart-button");

        // Elementos de la pantalla de inicio
        const startScreen = document.getElementById("start-screen");
        const studentNameInput = document.getElementById("student-name-input");
        const gradeSelection = document.getElementById("grade-selection"); // Nuevo
        const startGameButton = document.getElementById("start-game-button");
        const studentNameDisplay = document.getElementById("student-name-display");

        // Elementos de los controles táctiles
        const upButton = document.getElementById('up-button');
        const downButton = document.getElementById('down-button');
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');

        const box = 20;
        let snake = [];
        let direction = null;
        let food = {};
        let rat = {};
        let score = 0;
        let level = 1;
        let gameSpeed = 150;
        let gameInterval;
        let selectedGradeQuestions = {}; // Almacenará las preguntas del grado seleccionado

        let currentLevelQuestions = [];

        let currentQuestion = null;

        let gamePausedForQuestion = true;
        let overlayQuestionTimer;

        const QUESTIONS_TO_LEVEL_UP = 3; // Cuántas preguntas correctas para subir de nivel
        let questionsCorrectInCycle = 0;
        let questionsAnsweredInCycle = 0;

        let initialGameStartListener = null;
        let initialKeyPressHandlerRegistered = false;

        let shouldPresentNewQuestion = false;
        let studentName = "";
        let segmentsToAdd = 0;

        // --- IMÁGENES INCRUSTADAS EN BASE64 (Manzana y Ratón) ---
        const manzanaImg = new Image();
        manzanaImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANlBMVEVHcEyZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZlHh+gMAAAAC3RSTlMA652f1P1W+1e2gqCBAAAAIklEQVQY02NgIAgA7QY0gM3kIIDZgAMoG2sYyCAjA7A3MLDQAaZgJGBgYGLkYQJkYGJmYWJlY2BnYuFhY2BgZGVj4GAF/g4uXj5+AUGBgUFBISFhoWAQERERBQSFRURFR0TGJgYGxiamphZWAQEBAUJCw0LDxCYmJmcXFxdnby+oAC9JmB8wXgAAAAAElFTkSuQmCC';

        const ratonImg = new Image();
        ratonImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANlBMVEVHcEyZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZlHh+gMAAAAC3RSTlMA652f1P1W+1e2gqCBAAAAIklEQVQY02NgIAgA7QY0gM3kIIDZgAMoG2sYyCAjA7A3MLDQAaZgJGBgYGLkYQJkYGJmYWJlY2BnYuFhY2BgZGVj4GAF/g4uXj5+AUGBgUFBISFhoWAQERERBQSFRURFR0TGJgYGxiamphZWAQEBAUJCw0LDxCYmJmcXFxdnby+oAC9JmB8wXgAAAAAElFTkSuQmCC';

        // --- FUNCIONES DE UTILIDAD ---
        function randomPosition() {
            let pos;
            const forbiddenPositions = new Set();
            for (let i = 0; i < snake.length; i++) {
                forbiddenPositions.add(`${snake[i].x},${snake[i].y}`);
            }
            // Asegurarse de que la nueva posición no sea la de la otra comida tampoco
            if (food.x !== undefined) forbiddenPositions.add(`${food.x},${food.y}`);
            if (rat.x !== undefined) forbiddenPositions.add(`${rat.x},${rat.y}`);

            do {
                pos = {
                    x: Math.floor(Math.random() * (canvas.width / box)) * box,
                    y: Math.floor(Math.random() * (canvas.height / box)) * box,
                };
            } while (forbiddenPositions.has(`${pos.x},${pos.y}`));
            return pos;
        }

        function collision(head, array, checkAllSegments = false) {
            const startIndex = checkAllSegments ? 0 : 1; // Si checkAllSegments es true, incluye la cabeza
            for (let i = startIndex; i < array.length; i++) {
                if (head.x === array[i].x && head.y === array[i].y) {
                    return true;
                }
            }
            return false;
        }

        // --- INICIALIZACIÓN DEL JUEGO ---
        function initGame() {
            console.log("--- INICIO: Iniciando Juego ---");
            clearInterval(gameInterval);
            clearInterval(overlayQuestionTimer);

            const selectedGrade = gradeSelection.value;
            selectedGradeQuestions = {};
            // Deep copy of questions for the selected grade to allow modification
            for (const lvl in preguntasPorGrado[selectedGrade]) {
                selectedGradeQuestions[lvl] = [...preguntasPorGrado[selectedGrade][lvl]];
            }

            snake = [{ x: 9 * box, y: 10 * box }];
            direction = null;
            score = 0;
            level = 1;
            gameSpeed = 150;
            questionsCorrectInCycle = 0;
            questionsAnsweredInCycle = 0;
            segmentsToAdd = 0;
            currentQuestion = null;
            food = {};
            rat = {};
            gamePausedForQuestion = true;
            shouldPresentNewQuestion = false;

            scoreDisplay.innerText = "Puntaje: " + score;
            levelDisplay.innerText = "Nivel: " + level;
            gameOverScreen.style.display = "none";
            currentQuestionDisplay.innerText = "";
            gameOverTitle.innerText = "¡Juego Terminado!";
            finalScoreDisplay.innerText = "";

            studentNameDisplay.innerText = studentName ? `Jugador: ${studentName}` : "";

            startScreen.style.display = "none";
            canvas.style.display = "block";
            currentQuestionDisplay.style.display = "block";


            drawInitialState();

            console.log("INICIO: Mostrando instrucciones iniciales del juego.");
            showInitialInstructions();
            console.log("INICIO: initGame finalizado.");
        }

        function drawInitialState() {
            console.log("DIBUJO: Dibujando estado inicial de la serpiente.");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "lime" : "green";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
            }
        }

        // --- Gestión de la Pantalla de Inicio ---
        function showStartScreen() {
            console.log("ESTADO: Mostrando pantalla de inicio.");
            startScreen.style.display = "flex";
            canvas.style.display = "none";
            questionOverlay.style.display = "none";
            currentQuestionDisplay.style.display = "none";
            gameOverScreen.style.display = "none";
            // Asegurarse de que los controles táctiles estén ocultos aquí inicialmente
            // La media query se encargará de mostrarlos si es una pantalla pequeña
            document.getElementById('touch-controls').style.display = 'none';

            startGameButton.addEventListener('click', startGame);
            studentNameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    startGame();
                }
            });
            studentNameInput.focus();
        }

        function startGame() {
            studentName = studentNameInput.value.trim();
            if (studentName === "") {
                alert("Por favor, introduce tu nombre para empezar.");
                return;
            }
            console.log(`JUGADOR: Nombre del estudiante: ${studentName}, Grado seleccionado: ${gradeSelection.value}`);
            initGame();
        }

        // Función para manejar el inicio del juego desde cualquier input (teclado o táctil)
        function handleGameStartFromInput(inputDirection) {
            // Solo ejecuta si el juego está en pausa por la pantalla de inicio
            if (gamePausedForQuestion && initialKeyPressHandlerRegistered) {
                console.log(`EVENTO: Input "${inputDirection}" recibido para iniciar juego.`);

                // Desactivar el listener una vez que el juego ha empezado
                document.removeEventListener('keydown', initialGameStartListener);

                initialKeyPressHandlerRegistered = false; // Marcar que ya se ha iniciado

                direction = inputDirection; // Establecer la dirección inicial
                console.log("DIRECCIÓN: Dirección inicial establecida a:", direction);

                // Ocultar la pantalla de instrucciones con la animación
                questionOverlay.classList.add('slide-out');
                setTimeout(() => {
                    questionOverlay.style.display = "none";
                    console.log("ESTADO: Instrucciones iniciales ocultas. Preparando primera pregunta.");
                    loadLevelQuestionsForCurrentLevel(); // Cargar preguntas para el nivel 1
                    shouldPresentNewQuestion = true; // Indicar que se debe presentar una nueva pregunta
                    checkAndPresentQuestion(); // Proceder con la lógica de la pregunta
                }, 500); // Esperar a que termine la animación
            }
        }

        function showInitialInstructions() {
            console.log("ESTADO: Mostrando instrucciones iniciales. Juego pausado.");
            gamePausedForQuestion = true; // Asegurarse de que el juego esté en pausa
            questionOverlay.classList.remove('slide-out'); // Remover clase de animación
            questionOverlay.style.transform = 'translate(-50%, -50%)'; // Resetear posición
            questionOverlay.style.opacity = '1'; // Resetear opacidad

            overlayQuestionText.innerHTML = `
                <h2>¡Hola, ${studentName}!</h2>
                <p>Tu misión es guiar a la serpiente para que coma la respuesta correcta.</p>
                <p>Come la **manzana** si la respuesta es **Verdadero**.</p>
                <p>Come el **ratón** si es **Falso**.</p>
                <p>Responde ${QUESTIONS_TO_LEVEL_UP} preguntas para subir de nivel. ¡Cuidado, el juego se acelera!</p>
                <p>Evita chocar con las paredes o contigo mismo.</p>
                <p>¡Presiona **cualquier tecla de flecha** o **toca un botón de dirección** para empezar!</p>
            `;
            overlayTimerText.innerText = ""; // Limpiar temporizador

            questionOverlay.style.display = "flex";

            // Registrar el listener solo una vez para el inicio del juego
            if (!initialKeyPressHandlerRegistered) {
                initialGameStartListener = (event) => {
                    if (event.key.startsWith("Arrow")) {
                        setSnakeDirection(event.key.replace('Arrow', '').toUpperCase());
                    }
                };
                document.addEventListener('keydown', initialGameStartListener);
                initialKeyPressHandlerRegistered = true;
                console.log("EVENTO: Listeners para inicio de juego (teclado/táctil) configurados.");
            }
        }

        function loadLevelQuestionsForCurrentLevel() {
            console.log(`PREGUNTAS: Cargando preguntas para Nivel ${level} del grado ${gradeSelection.value}.`);
            currentLevelQuestions = selectedGradeQuestions[level] ? [...selectedGradeQuestions[level]] : [];
            if (currentLevelQuestions.length === 0) {
                console.warn(`PREGUNTAS: Advertencia: Nivel ${level} del grado ${gradeSelection.value} no tiene preguntas o está vacío.`);
            }
            console.log(`PREGUNTAS: Preguntas cargadas para Nivel ${level}: ${currentLevelQuestions.length} preguntas disponibles.`);
        }

        function checkAndPresentQuestion() {
            console.log("--- FLUJO: checkAndPresentQuestion() llamado ---");
            clearInterval(gameInterval); // Pausar el juego
            console.log(`ESTADO: Juego pausado para la pregunta. gamePausedForQuestion=${gamePausedForQuestion}, shouldPresentNewQuestion=${shouldPresentNewQuestion}`);

            // Lógica para subir de nivel
            if (questionsAnsweredInCycle >= QUESTIONS_TO_LEVEL_UP) {
                const nextLevel = level + 1;
                console.log(`NIVEL: Condición de nivel cumplida. Intentando subir a Nivel ${nextLevel}.`);
                if (selectedGradeQuestions[nextLevel] && selectedGradeQuestions[nextLevel].length > 0) {
                    level = nextLevel;
                    levelDisplay.innerText = "Nivel: " + level;
                    gameSpeed = Math.max(50, gameSpeed - 20); // AUMENTO DE VELOCIDAD AJUSTADO AQUÍ (antes -30, ahora -20)
                    questionsCorrectInCycle = 0; // Resetear contador de correctas
                    questionsAnsweredInCycle = 0; // Resetear contador de respondidas
                    loadLevelQuestionsForCurrentLevel(); // Cargar preguntas del nuevo nivel
                    console.log(`NIVEL: ¡Subiendo a Nivel ${level}! Velocidad: ${gameSpeed}. Nuevas preguntas cargadas: ${currentLevelQuestions.length}.`);
                } else {
                    console.log("NIVEL: ¡Has completado todos los niveles o no hay más preguntas para este grado! Llamando a showGameOver(true).");
                    showGameOver(true, "victoria"); // Ganaste el juego
                    return; // Detener la ejecución
                }
            }

            // Lógica para presentar una nueva pregunta
            if (shouldPresentNewQuestion) {
                console.log(`PREGUNTAS: shouldPresentNewQuestion es true. Preguntas restantes en currentLevelQuestions (antes de seleccionar): ${currentLevelQuestions.length}`);
                if (currentLevelQuestions.length === 0) {
                    // Si no quedan preguntas en el nivel actual, terminar el juego
                    console.log(`JUEGO: No quedan más preguntas en el nivel actual (${level}) para este grado. Fin del juego por agotamiento.`);
                    showGameOver(false, "agotamiento de preguntas"); // Game Over si no hay más preguntas
                    return;
                }

                // Seleccionar una pregunta aleatoria y eliminarla de las disponibles para este ciclo de nivel
                const randomIndex = Math.floor(Math.random() * currentLevelQuestions.length);
                currentQuestion = currentLevelQuestions.splice(randomIndex, 1)[0];
                console.log(`PREGUNTAS: Pregunta seleccionada: "${currentQuestion.texto}" (Nivel ${level}). Preguntas restantes en este nivel (después de eliminar): ${currentLevelQuestions.length}`);

                // Mostrar la pregunta en la superposición y abajo del juego
                overlayQuestionText.innerText = `Nivel ${level}: ${currentQuestion.texto}`;
                currentQuestionDisplay.innerText = `Nivel ${level}: ${currentQuestion.texto}`;

                // Mostrar la superposición de pregunta
                questionOverlay.style.display = "flex";
                questionOverlay.classList.remove('slide-out');
                questionOverlay.style.transform = 'translate(-50%, -50%)';
                questionOverlay.style.opacity = '1';

                let timeLeft = 6; // Tiempo para leer la pregunta (Cambiado a 6 segundos)
                overlayTimerText.innerText = `Tiempo para leer: ${timeLeft}`;
                clearInterval(overlayQuestionTimer); // Limpiar cualquier temporizador anterior
                overlayQuestionTimer = setInterval(() => {
                    timeLeft--;
                    overlayTimerText.innerText = `Tiempo para leer: ${timeLeft}`;
                    if (timeLeft <= 0) {
                        clearInterval(overlayQuestionTimer);
                        questionOverlay.classList.add('slide-out'); // Iniciar animación de salida
                        setTimeout(() => {
                            questionOverlay.style.display = "none";
                            shouldPresentNewQuestion = false; // Indicar que la pregunta ya fue presentada
                            console.log("TEMPORIZADOR: Temporizador de pregunta terminado. shouldPresentNewQuestion ahora es false. Llamando a resumeGame().");
                            resumeGame(); // Reanudar el juego una vez que la superposición se oculta
                        }, 500); // Esperar a que termine la animación
                    }
                }, 1000);

                // Generar nuevas posiciones para la manzana y el ratón
                generateBothFoods();
            } else {
                console.log("FLUJO: checkAndPresentQuestion() llamado sin shouldPresentNewQuestion true. Solo reanudando juego.");
                resumeGame();
            }
        }

        function generateBothFoods() {
            food = randomPosition(); // Generar posición para la manzana
            let ratPos;
            do {
                ratPos = randomPosition();
            } while (ratPos.x === food.x && ratPos.y === food.y); // Asegurarse de que no esté en la misma posición que la manzana
            rat = ratPos;
            console.log("ALIMENTOS: Alimentos generados: Manzana en", food, "Ratón en", rat);
        }

        function resumeGame() {
            console.log("--- FLUJO: Reanudando Juego ---");
            gamePausedForQuestion = false; // Permitir que el juego avance
            // Asegurarse de que la serpiente tenga una dirección inicial si no la tiene
            if (direction === null) {
                direction = "RIGHT"; // Por defecto, que empiece a la derecha
                console.log("DIRECCIÓN: Dirección establecida a RIGHT como respaldo al reanudar.");
            }

            console.log("ESTADO: Juego reanudado. gamePausedForQuestion:", gamePausedForQuestion, "Dirección actual:", direction, "Velocidad:", gameSpeed);
            clearInterval(gameInterval); // Limpiar cualquier intervalo previo para evitar múltiples ejecuciones
            gameInterval = setInterval(draw, gameSpeed); // Iniciar el bucle principal del juego
            console.log("LOOP: setInterval(draw, gameSpeed) iniciado.");
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpiar el canvas en cada fotograma

            // Dibujar la serpiente
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "lime" : "green";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
            }

            // --- DIBUJAR MANZANA ---
            if (food.x !== undefined) {
                // Puedes usar una imagen o dibujarla con formas
                ctx.fillStyle = "red"; // Color rojo para la manzana
                ctx.beginPath();
                ctx.arc(food.x + box / 2, food.y + box / 2, box / 2, 0, Math.PI * 2);
                ctx.fill();
                // O si usas imagen: ctx.drawImage(manzanaImg, food.x, food.y, box, box);
            }

            // --- DIBUJAR RATÓN ---
            if (rat.x !== undefined) {
                // Puedes usar una imagen o dibujarlo con formas
                ctx.fillStyle = "gray"; // Color gris para el ratón
                ctx.fillRect(rat.x, rat.y, box, box);
                // O si usas imagen: ctx.drawImage(ratonImg, rat.x, rat.y, box, box);
            }

            // Mover la cabeza de la serpiente
            let headX = snake[0].x;
            let headY = snake[0].y;

            if (!gamePausedForQuestion && direction !== null) { // Solo mover si el juego no está pausado y hay dirección
                if (direction === "LEFT") headX -= box;
                else if (direction === "UP") headY -= box;
                else if (direction === "RIGHT") headX += box;
                else if (direction === "DOWN") headY += box;

                const newHead = { x: headX, y: headY };

                // Lógica de colisión con el propio cuerpo o paredes
                let bodyCollision = false;
                let willEatFood = (newHead.x === food.x && newHead.y === food.y) || (newHead.x === rat.x && newHead.y === rat.y);

                // Si va a comer, no consideres la última parte del cuerpo para la colisión
                // porque esa parte se moverá. Si no va a comer, sí la consideras.
                if (willEatFood) {
                    bodyCollision = collision(newHead, snake, true); // Comprueba con todo el cuerpo, incluyendo la cabeza
                } else {
                    const snakeBodyForCollision = snake.slice(0, snake.length - 1); // Quita el último segmento
                    bodyCollision = collision(newHead, snakeBodyForCollision); // Comprueba con el resto del cuerpo
                }

                if (
                    newHead.x < 0 ||
                    newHead.x >= canvas.width ||
                    newHead.y < 0 ||
                    newHead.y >= canvas.height ||
                    bodyCollision
                ) {
                    console.error("JUEGO: ¡GAME OVER! Razón: Colisión con pared o cuerpo. Nueva cabeza:", newHead, "Serpiente actual:", snake);
                    showGameOver(false, "colision"); // Llama a la pantalla de Game Over
                    return; // Detener el bucle del juego
                }

                // Lógica de comer comida
                if (willEatFood) {
                    let foodTypeEaten;
                    // Determinar qué tipo de "comida" fue consumida ANTES de vaciar los objetos
                    if (newHead.x === food.x && newHead.y === food.y) {
                        foodTypeEaten = 'manzana';
                    } else if (newHead.x === rat.x && newHead.y === rat.y) {
                        foodTypeEaten = 'raton';
                    }

                    food = {}; // Vaciar la posición de la manzana
                    rat = {}; // Vaciar la posición del ratón

                    let isCorrectAnswer = false;
                    // Verificar si la respuesta es correcta
                    if (currentQuestion.respuesta === true && foodTypeEaten === 'manzana') {
                        isCorrectAnswer = true;
                    } else if (currentQuestion.respuesta === false && foodTypeEaten === 'raton') {
                        isCorrectAnswer = true;
                    }

                    if (isCorrectAnswer) {
                        score++; // Incrementar puntaje
                        questionsCorrectInCycle++; // Incrementar contador de respuestas correctas en el ciclo
                        console.log(`RESPUESTA: ¡Correcta! Puntaje: ${score}, Correctas en ciclo: ${questionsCorrectInCycle}.`);
                    } else {
                        // Si la respuesta es incorrecta, aquí puedes añadir una penalización, por ejemplo
                        // score = Math.max(0, score - 1); // Restar puntos, pero no menos de 0
                        console.log(`RESPUESTA: ¡Incorrecta!`);
                    }

                    // Añadir la nueva cabeza. El segmento "extra" se mantiene
                    snake.unshift(newHead);
                    segmentsToAdd += 1; // Un segmento adicional que se añadirá en la próxima iteración

                    questionsAnsweredInCycle++; // Incrementar el contador de preguntas respondidas
                    console.log(`PREGUNTA: Preguntas respondidas en ciclo: ${questionsAnsweredInCycle}. Largo serpiente: ${snake.length + segmentsToAdd}`);

                    scoreDisplay.innerText = "Puntaje: " + score; // Actualizar el display de puntaje

                    shouldPresentNewQuestion = true; // Indicar que se debe presentar una nueva pregunta
                    console.log(`FLUJO: Comida consumida. shouldPresentNewQuestion es true. Llamando a checkAndPresentQuestion().`);
                    checkAndPresentQuestion(); // Pausar el juego para la siguiente pregunta
                    return; // Detener el bucle actual para esperar la pregunta
                } else {
                    // Si no comió, solo mueve la serpiente (elimina la cola si no hay segmentos que añadir)
                    if (segmentsToAdd <= 0) {
                        snake.pop(); // Eliminar el último segmento para que la serpiente se mueva
                    } else {
                        segmentsToAdd--; // Si hay segmentos por añadir, decrementa el contador
                    }
                }

                snake.unshift(newHead); // Añadir la nueva cabeza
            }
        }

        // --- MANEJO DE DIRECCIÓN (para teclado y táctil) ---
        function setSnakeDirection(newDir) {
            // Si el juego está pausado por la pantalla de inicio, solo captura la primera dirección para empezar
            if (gamePausedForQuestion) {
                if (initialKeyPressHandlerRegistered) { // Asegurarse de que es el inicio del juego
                    handleGameStartFromInput(newDir); // Llamar a la función que inicia el juego
                    return;
                }
                console.log(`INPUT: Dirección "${newDir}" ignorada. Juego pausado por pregunta.`);
                return; // Ignorar input si está en pausa por pregunta activa
            }

            // Lógica para cambiar la dirección de la serpiente (evitar giros en U)
            if (direction !== null) { // Asegurarse de que ya hay una dirección establecida
                if (newDir === "LEFT" && direction !== "RIGHT") {
                    direction = "LEFT";
                } else if (newDir === "UP" && direction !== "DOWN") {
                    direction = "UP";
                } else if (newDir === "RIGHT" && direction !== "LEFT") {
                    direction = "RIGHT";
                } else if (newDir === "DOWN" && direction !== "UP") {
                    direction = "DOWN";
                }
            } else { // Para la primera dirección después de una pausa sin dirección definida
                direction = newDir;
                console.log("INPUT: Primera dirección establecida en juego activo:", direction);
            }
        }

        // Listener de teclado (llama a setSnakeDirection)
        document.addEventListener("keydown", (event) => {
            if (event.key.startsWith("Arrow")) {
                setSnakeDirection(event.key.replace('Arrow', '').toUpperCase());
            }
        });

        // Listeners para los botones táctiles (llaman a setSnakeDirection)
        if (upButton) upButton.addEventListener('click', () => setSnakeDirection('UP'));
        if (downButton) downButton.addEventListener('click', () => setSnakeDirection('DOWN'));
        if (leftButton) leftButton.addEventListener('click', () => setSnakeDirection('LEFT'));
        if (rightButton) rightButton.addEventListener('click', () => setSnakeDirection('RIGHT'));

        // --- PANTALLA DE GAME OVER / JUEGO COMPLETADO ---
        function showGameOver(isVictory, reason = "desconocido") {
            console.log(`--- JUEGO: Mostrando Pantalla Game Over (Victoria: ${isVictory}, Razón: ${reason}) ---`);
            clearInterval(gameInterval); // Detener el bucle del juego
            clearInterval(overlayQuestionTimer); // Detener cualquier temporizador de pregunta
            gamePausedForQuestion = true; // Asegurarse de que el juego esté en pausa
            gameOverScreen.style.display = "flex"; // Mostrar la pantalla de Game Over
            currentQuestionDisplay.innerText = ""; // Limpiar la pregunta mostrada
            questionOverlay.style.display = "none"; // Ocultar la superposición de pregunta si está visible
            questionOverlay.classList.remove('slide-out'); // Limpiar clases de animación
            questionOverlay.style.transform = 'translate(-50%, -50%)'; // Resetear posición
            questionOverlay.style.opacity = '1'; // Resetear opacidad

            if (isVictory) {
                gameOverTitle.innerText = "¡Felicidades, Juego Completado!"; // Mensaje de victoria
                finalScoreDisplay.innerText = `¡Has respondido todas las preguntas de tu grado!\nPuntaje final: ${score}`;
                console.log("JUEGO: ¡FELICIDADES, HAS COMPLETADO EL JUEGO!");
            } else {
                gameOverTitle.innerText = "¡Juego Terminado!"; // Mensaje de Game Over normal
                finalScoreDisplay.innerText = `Puntaje final: ${score}`;
                console.log("JUEGO: GAME OVER.");
            }
        }

        // --- EVENTO DE REINICIO ---
        restartButton.addEventListener("click", initGame);

        // --- INICIAR LA PANTALLA DE INICIO AL CARGAR LA PÁGINA ---
        window.onload = showStartScreen;
    </script>
</body>
</html>
